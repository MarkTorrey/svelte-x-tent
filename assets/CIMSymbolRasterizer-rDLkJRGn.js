import{bB as E,aJ as S,fy as G,O as J,bj as U}from"./index-eSY5-lt-.js";import{r as q,b as B,n as X,e as Q,j as V,V as K,Q as Z}from"./cimAnalyzer-DsuWkQlK.js";import{i as $}from"./CIMResourceManager-RJnqsZ6j.js";import{c as ee}from"./Rasterizer-JVG-pIoh.js";import{O as te,c as ae,t as _,r as Y}from"./utils-jQLeeGOF.js";import{m as ie}from"./cimSymbolUtils-i5s4LTBQ.js";import"./fontUtils-GE0ho--n.js";import"./BidiEngine-8z8MVveq.js";import"./labelPoint-mThgM4t0.js";import"./OptimizedGeometry-CbNXANBG.js";import"./GeometryUtils-CEMOhUyj.js";import"./enums--FbEXJ87.js";import"./alignmentUtils-XT3TYmYW.js";import"./definitions-otzk_d_r.js";import"./number-sTjsTbdA.js";import"./Rect-pT1ASav_.js";import"./callExpressionWithFeature-rytrJuuz.js";import"./quantizationUtils-DTwa03mn.js";import"./floatRGBA-9E5qKLsz.js";import"./imageUtils-tXDgLQzN.js";import"./rasterizingUtils-vy6gAIzi.js";const T=I=>I!=null&&I.scaleFactor?I.scaleFactor:1,re=96/72;class De{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new q,this._cimResourceManager=new $,this._rasterizer=new ee(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??(this._lazyImageDataCanvas=document.createElement("canvas")),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,e,s,i,a,o,l,r,d){if(!t)return null;const{data:m}=t;if(!m||m.type!=="CIMSymbolReference"||!m.symbol)return null;const{symbol:u}=m;o||(o=te(u));const f=await B.resolveSymbolOverrides(m,e,this._spatialReference,a,o,l,r),c=this._imageDataCanvas,y=this._cimResourceManager,w=[];X.fetchResources(f,y,w),X.fetchFonts(f,y,w),w.length>0&&await Promise.all(w);const{width:h,height:g}=s,x=oe(o,h,g,i),n=X.getEnvelope(f,x,y);if(!n)return null;const P=(window.devicePixelRatio||1)*re;let p=1,R=0,M=0;switch(u.type){case"CIMPointSymbol":case"CIMTextSymbol":{let k=1;n.width>h&&(k=h/n.width);let C=1;n.height>g&&(C=g/n.height),i==="preview"&&(n.width<h&&(k=h/n.width),n.height<g&&(C=g/n.height)),p=Math.min(k,C),R=n.x+n.width/2,M=n.y+n.height/2}break;case"CIMLineSymbol":{(d||n.height>g)&&(p=g/n.height),M=n.y+n.height/2;const k=n.x*p+h/2,C=(n.x+n.width)*p+h/2,{paths:b}=x;b[0][0][0]-=k/p,b[0][2][0]-=(C-h)/p}break;case"CIMPolygonSymbol":{R=n.x+n.width/2,M=n.y+n.height/2;const k=n.x*p+h/2,C=(n.x+n.width)*p+h/2,b=n.y*p+g/2,F=(n.y+n.height)*p+g/2,{rings:D}=x;k<0&&(D[0][0][0]-=k,D[0][3][0]-=k,D[0][4][0]-=k),b<0&&(D[0][0][1]+=b,D[0][1][1]+=b,D[0][4][1]+=b),C>h&&(D[0][1][0]-=C-h,D[0][2][0]-=C-h),F>g&&(D[0][2][1]+=F-g,D[0][3][1]+=F-g)}}c.width=h*P,c.height=g*P;const z=1;c.width+=2*z,c.height+=2*z;const v=this._imageDataContext,A=Z.createIdentity();return A.translate(-R,-M),A.scale(p*P,-p*P),A.translate(h*P/2+z,g*P/2+z),v.clearRect(0,0,c.width,c.height),new Q(v,y,A,!0).drawSymbol(f,x),v.getImageData(0,0,c.width,c.height)}async analyzeCIMSymbol3D(t,e,s,i,a){const o=[],l=e?{geometryType:i,spatialReference:this._spatialReference,fields:e}:null,r=[];X.fetchFonts(t.data.symbol,this._cimResourceManager,r),await Promise.all(r);const d=new V(this._cimResourceManager,l);let m;await d.analyzeSymbolReference(t.data,this._avoidSDF,o),E(a);for(const u of o)u.cim.type!=="CIMPictureMarker"&&u.cim.type!=="CIMPictureFill"&&u.cim.type!=="CIMPictureStroke"||(m||(m=[]),m.push(this._fetchPictureMarkerResource(u,a))),s&&u.type==="text"&&typeof u.text=="string"&&u.text.includes("[")&&(u.text=ae(s,u.text,u.cim.textCase));return m&&await Promise.all(m),o}rasterizeCIMSymbol3D(t,e,s,i,a,o){const l=[];for(const r of t){i&&typeof i.scaleFactor=="function"&&(i.scaleFactor=i.scaleFactor(e,a,o));const d=this._getRasterizedResource(r,e,s,i,a,o);if(!d)continue;let m=0,u=d.anchorX||0,f=d.anchorY||0,c=!1,y=0,w=0;if(s==="esriGeometryPoint"){const h=T(i);if(y=_(r.offsetX,e,a,o)*h||0,w=_(r.offsetY,e,a,o)*h||0,r.type==="marker")m=_(r.rotation,e,a,o)||0,c=r.rotateClockwise??!1;else if(r.type==="text"){if(m=_(r.angle,e,a,o)||0,r.horizontalAlignment!==void 0)switch(r.horizontalAlignment){case"left":u=-.5;break;case"right":u=.5;break;default:u=0}if(r.verticalAlignment!==void 0)switch(r.verticalAlignment){case"top":f=.5;break;case"bottom":f=-.5;break;case"baseline":f=-.25;break;default:f=0}}}d!=null&&l.push({angle:m,rotateClockWise:c,anchorX:u,anchorY:f,offsetX:y,offsetY:w,rasterizedResource:d})}return this.getSymbolImage(l)}getSymbolImage(t){const e=document.createElement("canvas"),s=e.getContext("2d");let i=0,a=0,o=0,l=0;const r=[];for(let f=0;f<t.length;f++){const c=t[f],y=c.rasterizedResource;if(!y)continue;const w=y.size,h=c.offsetX,g=c.offsetY,x=c.anchorX,n=c.anchorY,P=c.rotateClockWise||!1;let p=c.angle,R=S(h)-w[0]*(.5+x),M=S(g)-w[1]*(.5+n),z=R+w[0],v=M+w[1];if(p){P&&(p=-p);const C=Math.sin(p*Math.PI/180),b=Math.cos(p*Math.PI/180),F=R*b-M*C,D=R*C+M*b,O=R*b-v*C,H=R*C+v*b,L=z*b-v*C,W=z*C+v*b,N=z*b-M*C,j=z*C+M*b;R=Math.min(F,O,L,N),M=Math.min(D,H,W,j),z=Math.max(F,O,L,N),v=Math.max(D,H,W,j)}i=R<i?R:i,a=M<a?M:a,o=z>o?z:o,l=v>l?v:l;const A=s.createImageData(y.size[0],y.size[1]);A.data.set(new Uint8ClampedArray(y.image.buffer));const k={offsetX:h,offsetY:g,rotateClockwise:P,angle:p,rasterizedImage:A,anchorX:x,anchorY:n};r.push(k)}e.width=o-i,e.height=l-a;const d=-i,m=l;for(let f=0;f<r.length;f++){const c=r[f],y=this._imageDataToCanvas(c.rasterizedImage),w=c.rasterizedImage.width,h=c.rasterizedImage.height,g=d-w*(.5+c.anchorX),x=m-h*(.5-c.anchorY);if(c.angle){const n=(360-c.angle)*Math.PI/180;s.save(),s.translate(S(c.offsetX),-S(c.offsetY)),s.translate(d,m),s.rotate(n),s.translate(-d,-m),s.drawImage(y,g,x),s.restore()}else s.drawImage(y,g+S(c.offsetX),x-S(c.offsetY))}const u=new G({x:d/e.width-.5,y:m/e.height-.5});return{imageData:e.width!==0&&e.height!==0?s.getImageData(0,0,e.width,e.height):s.createImageData(1,1),anchorPosition:u}}async _fetchPictureMarkerResource(t,e){const s=t.materialHash;if(!this._pictureMarkerCache.get(s)){const i=(await J(t.cim.url,{responseType:"image",signal:e==null?void 0:e.signal})).data;this._pictureMarkerCache.set(s,i)}}_imageDataToCanvas(t){const e=this._imageDataCanvas,s=this._imageDataContext;return e.width=t.width,e.height=t.height,s.putImageData(t,0,0),e}_imageTo32Array(t,e,s,i){const a=this._imageDataCanvas,o=this._imageDataContext;if(a.width=e,a.height=s,o.drawImage(t,0,0,e,s),i){o.save();const l=new U(i);o.fillStyle=l.toHex(),o.globalCompositeOperation="multiply",o.fillRect(0,0,e,s),o.globalCompositeOperation="destination-atop",o.drawImage(t,0,0,e,s),o.restore()}return new Uint32Array(o.getImageData(0,0,e,s).data.buffer)}_getRasterizedResource(t,e,s,i,a,o){let l,r,d;if(t.type==="text")return this._rasterizeTextResource(t,e,i,a,o);({analyzedCIM:l,hash:r}=se(t,e,a,o));const f=T(i);if(t.cim.type==="CIMPictureMarker"){const w=_(t.size,e,a,o)*f,{image:h,width:g,height:x}=this._getPictureResource(t,w,_(t.color,e,a,o));return d={image:h,size:[g,x],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},d}ie(l,f,{preserveOutlineWidth:!1});const c=l;r+=s,i&&(r+=JSON.stringify(i));const y=this._resourceCache;return y.has(r)?y.get(r):(d=this._rasterizer.rasterizeJSONResource({cim:c,type:t.type,url:t.url,mosaicHash:r,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),y.set(r,d),d)}_rasterizeTextResource(t,e,s,i,a){var M,z,v;const o=T(s),l=_(t.text,e,i,a);if(!l||l.length===0)return null;const r=t.cim,d=_((r==null?void 0:r.fontFamilyName)||t.fontName,e,i,a),m=_(((M=r==null?void 0:r.font)==null?void 0:M.style)||t.style,e,i,a),u=_(((z=r==null?void 0:r.font)==null?void 0:z.weight)||t.weight,e,i,a),f=_(((v=r==null?void 0:r.font)==null?void 0:v.decoration)||t.decoration,e,i,a),c=_(t.size,e,i,a)*o,y=_(t.horizontalAlignment,e,i,a),w=_(t.verticalAlignment,e,i,a),h=Y(_(t.color,e,i,a)),g=Y(_(t.outlineColor,e,i,a)),x=_(t.outlineSize,e,i,a),n=t.backgroundColor!=null?Y(t.backgroundColor):null,P=t.borderLineColor!=null?Y(t.borderLineColor):null,p=t.borderLineWidth!=null?t.borderLineWidth:null,R={color:h,size:c,horizontalAlignment:y,verticalAlignment:w,font:{family:d,style:m,weight:u,decoration:f},halo:{size:x||0,color:g,style:m},backgroundColor:n,borderLine:P!=null&&p!=null?{color:P,size:p}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(l,R)}_getPictureResource(t,e,s){const i=this._pictureMarkerCache.get(t.materialHash);if(!i)return null;const a=i.height/i.width,o=e?a>1?S(e):S(e)/a:i.width,l=e?a>1?S(e)*a:S(e):i.height;return{image:this._imageTo32Array(i,o,l,s),width:o,height:l}}}function oe(I,t,e,s){const a=-t/2+1,o=t/2-1,l=e/2-1,r=-e/2+1;switch(I){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[o,0]]]};default:return s==="legend"?{rings:[[[a,l],[o,0],[o,r],[a,r],[a,l]]]}:{rings:[[[a,l],[o,l],[o,r],[a,r],[a,l]]]}}}function se(I,t,e,s){let i,a;return typeof I.materialHash=="function"?(i=(0,I.materialHash)(t,e,s),a=K(I.cim,I.materialOverrides)):(i=I.materialHash,a=I.cim),{analyzedCIM:a,hash:i}}export{De as CIMSymbolRasterizer};
