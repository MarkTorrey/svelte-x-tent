import{i as k}from"./CIMResourceManager-DiZ9873h.js";import{e as _,s as E,$ as F}from"./CIMSymbolHelper-vq9rAQVS.js";import{y as G}from"./OverrideHelper-cJgBvMlU.js";import{V as P}from"./utils-DpS7XCOa.js";import"./fontUtils-CiOfLTjw.js";import"./index-BdDnxAOC.js";import"./BidiEngine-DNnuvc1i.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./GeometryUtils-gjMcVHTd.js";import"./enums-CmIX1y88.js";import"./Rect-CUzevAry.js";import"./BoundingBox-Tk_OBeCC.js";import"./defaults-BX3STjdr.js";import"./defaultsJSON-GKolV7NZ.js";import"./colorUtils-CXI_GYiL.js";import"./quantizationUtils-BIIdN1xY.js";const $=96/72;class Y{constructor(g){this._spatialReference=g,this._imageDataCanvas=null,this._cimResourceManager=new k}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(g,p,w,f,s,a,n,o,M){if(!g)return null;const{data:c}=g;if(!c||c.type!=="CIMSymbolReference"||!c.symbol)return null;const{symbol:C}=c;a||(a=P(C));const r=await G.resolveSymbolOverrides(c,p,this._spatialReference,s,a,n,o),l=this._cimResourceManager,u=[];_.fetchResources(r,l,u),_.fetchFonts(r,l,u),u.length>0&&await Promise.all(u);const{width:t,height:i}=w,R=D(a,t,i,f),e=_.getEnvelope(r,R,l);if(!e)return null;e.x===1/0&&(e.x=t+2),e.y===1/0&&(e.y=-i/2),e.width===-1/0&&(e.width=t),e.height===-1/0&&(e.height=i);let h=1,v=0,x=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let m=1;e.width>t&&(m=t/e.width);let d=1;e.height>i&&(d=i/e.height),f==="preview"&&(e.width<t&&(m=t/e.width),e.height<i&&(d=i/e.height)),h=Math.min(m,d),v=e.x+e.width/2,x=e.y+e.height/2}break;case"CIMLineSymbol":{(M||e.height>i)&&(h=i/e.height),x=e.y+e.height/2;const m=e.x*h+t/2,d=(e.x+e.width)*h+t/2,{paths:b}=R;b[0][0][0]-=m/h,b[0][2][0]-=(d-t)/h}break;case"CIMPolygonSymbol":{v=e.x+e.width/2,x=e.y+e.height/2;const m=e.x*h+t/2,d=(e.x+e.width)*h+t/2,b=e.y*h+i/2,I=(e.y+e.height)*h+i/2,{rings:y}=R;m<0&&(y[0][0][0]-=m,y[0][3][0]-=m,y[0][4][0]-=m),b<0&&(y[0][0][1]+=b,y[0][1][1]+=b,y[0][4][1]+=b),d>t&&(y[0][1][0]-=d-t,y[0][2][0]-=d-t),I>i&&(y[0][2][1]+=I-i,y[0][3][1]+=I-i)}}const z={type:"cim",data:{type:"CIMSymbolReference",symbol:r}};return this.rasterize(z,t,i,v,x,h,a,1,R)}rasterize(g,p,w,f,s,a,n,o=0,M=null){const{data:c}=g;if(!c||c.type!=="CIMSymbolReference"||!c.symbol)return null;const{symbol:C}=c,r=this._canvas,l=(window.devicePixelRatio||1)*$;r.width=p*l,r.height=w*l,n||(n=P(C)),M||(M=D(n,p,w,"legend")),r.width+=2*o,r.height+=2*o;const u=r.getContext("2d",{willReadFrequently:!0}),t=F.createIdentity();return t.translate(-f,-s),t.scale(a*l,-a*l),t.translate(p*l/2+o,w*l/2+o),u.clearRect(0,0,r.width,r.height),new E(u,this._cimResourceManager,t,!0).drawSymbol(C,M),u.getImageData(0,0,r.width,r.height)}}function D(S,g,p,w){const s=-g/2+1,a=g/2-1,n=p/2-1,o=-p/2+1;switch(S){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[a,0]]]};default:return w==="legend"?{rings:[[[s,n],[a,0],[a,o],[s,o],[s,n]]]}:{rings:[[[s,n],[a,n],[a,o],[s,o],[s,n]]]}}}export{Y as CIMSymbolRasterizer};
