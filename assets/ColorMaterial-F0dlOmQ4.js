const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ShadedColorMaterial.glsl-BLEA2yV8.js","./index-BdDnxAOC.js","./index-BvbKYc24.css","./colorUtils-CXI_GYiL.js","./Octree-CHZqCJI3.js","./Util-CMsZAslL.js","./lineSegment-BdB5sSqU.js","./RibbonLine.glsl-woeA5PUM.js","./orientedBoundingBox-CDDAEjLg.js","./spatialReferenceEllipsoidUtils-dsdmGygT.js","./computeTranslationToOriginAndRotation-BpuGNDNV.js","./Geometry-0zkcBCci.js","./NormalAttribute.glsl-BvcOWU6V.js","./interfaces-CJw7Cnm-.js","./VertexAttribute-Cq4MnHjR.js","./renderState-BKlWY516.js","./basicInterfaces-CZwQPxTp.js","./BindType-BmZEZMMh.js","./boundedPlane-CkcDH2eT.js","./AlphaCutoff-UcccL64p.js","./requestImageUtils-vR0S8NIj.js","./BufferView-DDmSnYbN.js","./Indices-DL2vOaxI.js","./triangle-DshsWHpa.js","./dehydratedFeatureUtils-BOLOU81j.js","./IntersectorInterfaces-BgX4KEwK.js","./doublePrecisionUtils-B0owpBza.js","./vec3f32-nZdmKIgz.js","./InterleavedLayout-D4EIJKmV.js","./types-D0PSWh4d.js","./floatRGBA-CrOZxjHk.js","./HUDMaterial.glsl-tln8Kpvy.js","./NestedMap-GuqgquCN.js","./glUtil-Dw6UJ_iI.js","./VertexElementDescriptor-BOD-G50G.js","./VertexArrayObject-BNd6u6rq.js","./BufferObject-CMCaTtYE.js","./SnappingVisualizer-CEf62Vs9.js","./PointSnappingHint-xTfZ1GaJ.js"])))=>i.map(i=>d[i]);
import{cI as Xe,te as Ht,tf as kr,li as $e,W as d,fA as Ee,X as v,dx as Fe,Y as z,lz as ht,aA as Me,ak as Sr,aW as Qr,ja as Ye,ou as Nt,jd as ie,bo as Xr,aU as Yr,aQ as U,b8 as Jr,aR as Zr,dL as Kr,bp as N,a$ as It,_ as Y,tg as ei,az as w,bA as De,th as k,cm as Or,Z as Se,$ as ti,bM as Ie,e5 as Pr,ec as ri,e8 as $r,ea as Ze,kT as oe,is as ae,bx as Gt,kQ as ii,ti as Dr,np as Ir,V as si,dG as At,o3 as Wt,aJ as ai,ot as Vt,kp as ni,jf as oi,bj as Ar,jg as wt,bh as li,k1 as hi,b4 as Er,tj as ci,op as di,bb as ui,oJ as te,oK as fe,nT as we,hB as zt,ar as ve,nQ as O,tk as gi,oI as qt,q4 as pi,iv as _i,aN as mi,ep as Fr,ly as xe,jr as Mr,dO as fi,iM as ct,dR as vi,tl as xi,M as yi,tm as dt,o9 as Ci,tn as wi,hJ as bi,jl as Ti,je as Ri,jq as Si,qa as Oi,to as Pi,pU as $i}from"./index-BdDnxAOC.js";import{t as Di,_ as Ii,C as Ai,e as We,b as Ut,c as Ei}from"./RibbonLine.glsl-woeA5PUM.js";import{Z as W,az as Lr,a5 as Fi,o as ne,a2 as Mi,a3 as Li,j as jt,_ as bt,v as Bt,Q as J,R as Et,k as V,M as Hr,aA as kt,B as Ae,U as Z,V as K,T as Nr,X as Hi,Y as ut,O as Ni,A as P,ah as Ke,aB as gt,af as Pe,aC as Gi,aD as Wi,aE as Vi,aF as zi,aq as D,aG as qi,m as pt,at as Ui,aw as ji,a as Bi,D as ki,aa as Qi,F as Xi,I as Yi,P as Qt,ac as Ji,c as Zi,ab as Ki,a6 as es,ai as ts,aj as rs,ak as is,al as ss,am as as,an as ns,ao as os,ap as ls,as as hs,K as cs,ar as ds,au as us,ax as gs,aH as ps,aI as _s}from"./Geometry-0zkcBCci.js";import{n as S,l as _t,C as Xt,h as ms}from"./NormalAttribute.glsl-BvcOWU6V.js";import{r as fs,i as at,s as vs,n as xs,x as ys,E as Yt,I as mt,f as Cs,u as ws}from"./HUDMaterial.glsl-tln8Kpvy.js";import{o as C,t as Le}from"./interfaces-CJw7Cnm-.js";import{e as G}from"./VertexAttribute-Cq4MnHjR.js";import{a as bs}from"./BindType-BmZEZMMh.js";import{j as Ts,v as Jt,w as Zt}from"./axisAngleDegrees-BmgwC-EO.js";import{B as Q,c as Ft,g as X,f as Rs}from"./renderState-BKlWY516.js";import{a as Ve,e as Mt}from"./basicInterfaces-CZwQPxTp.js";import{t as et}from"./VertexElementDescriptor-BOD-G50G.js";import{E as Kt}from"./BufferObject-CMCaTtYE.js";import{t as Ss}from"./NestedMap-GuqgquCN.js";import{s as ye,u as Os,c as ce,f as ze}from"./Util-CMsZAslL.js";import{b as Ps,a as $s,G as Ds}from"./dehydratedFeatureUtils-BOLOU81j.js";import{e as er,i as Is}from"./IntersectorInterfaces-BgX4KEwK.js";import"./boundedPlane-CkcDH2eT.js";import{H as As}from"./InterleavedLayout-D4EIJKmV.js";import{o as Es}from"./AlphaCutoff-UcccL64p.js";var B,tr,rr;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(B||(B={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(tr||(tr={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}(rr||(rr={}));let ir=class{constructor(){this._extent=Xe(),this.resolution=0,this.renderLocalOrigin=Di(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Fs}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryView();const r=.001*e.range;if(this._extent[0]-r<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ht(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ht(this._extent,-e.range,0,i)}}setupGeometryView(){this.canvasGeometries.numViews=1,kr(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},Fs=class{constructor(){this.extents=[Xe(),Xe(),Xe()],this.numViews=0}};var b;(function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(b||(b={}));let Ms=class{constructor(e,r,i){this._fbos=e,this._format=r,this._name=i}get valid(){var e;return((e=this._handle)==null?void 0:e.getTexture())!=null}dispose(){this._handle=$e(this._handle)}get texture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}bind(e,r,i){var s,a,n,l;this._handle&&((s=this._handle.fbo)==null?void 0:s.width)===r&&((a=this._handle.fbo)==null?void 0:a.height)===i||((n=this._handle)==null||n.release(),this._handle=this._fbos.acquire(r,i,this._name,this._format)),e.bindFramebuffer((l=this._handle)==null?void 0:l.fbo)}generateMipMap(){var e,r,i,s,a;(i=(r=(e=this._handle)==null?void 0:e.getTexture())==null?void 0:r.descriptor)!=null&&i.hasMipmap&&((a=(s=this._handle)==null?void 0:s.getTexture())==null||a.generateMipmap())}},de=class{constructor(e,r,i,s,a=W.RGBA_MIPMAP){this.output=i,this.content=s,this.fbo=new Ms(e,a,r)}get valid(){return this.fbo.valid}},Ls=class{constructor(e){this.targets=[new de(e,"overlay color",S.Color,b.Color),new de(e,"overlay IM color",S.Color,b.ColorNoRasterImage),new de(e,"overlay highlight",S.Highlight,b.Highlight,W.RG),new de(e,"overlay water",S.Normal,b.WaterNormal),new de(e,"overlay occluded",S.Color,b.Occluded)],Lr()&&this.targets.push(new de(e,"overlay olid",S.ObjectAndLayerIdColor,b.ObjectAndLayerIdColor,W.RGBA))}getTexture(e){var r;return(r=this.targets[e])==null?void 0:r.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,i)=>r.valid?e|=1<<i:e,0)}};var sr;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight",t[t.ViewshedShadowMap=3]="ViewshedShadowMap"})(sr||(sr={}));var j,tt;function Hs(t){return t!=null&&!t.running}(function(t){t[t.Idle=0]="Idle",t[t.Rendering=1]="Rendering",t[t.Ready=2]="Ready",t[t.Fading=3]="Fading"})(j||(j={})),function(t){t[t.RG=0]="RG",t[t.BA=1]="BA",t[t.COUNT=2]="COUNT"}(tt||(tt={}));var Tt;let qe=Tt=class extends Fe{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new Tt({cloudCover:this.cloudCover})}};d([Ee({cloudy:"cloudy"})],qe.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],qe.prototype,"cloudCover",void 0),qe=Tt=d([z("esri.views.3d.environment.CloudyWeather")],qe);var Rt;let Ue=Rt=class extends Fe{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new Rt({fogStrength:this.fogStrength})}};d([Ee({foggy:"foggy"})],Ue.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ue.prototype,"fogStrength",void 0),Ue=Rt=d([z("esri.views.3d.environment.FoggyWeather")],Ue);var St;let be=St=class extends Fe{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new St({cloudCover:this.cloudCover,precipitation:this.precipitation})}};d([Ee({rainy:"rainy"})],be.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],be.prototype,"cloudCover",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],be.prototype,"precipitation",void 0),be=St=d([z("esri.views.3d.environment.RainyWeather")],be);var Ot;let ue=Ot=class extends Fe{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new Ot({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};d([Ee({snowy:"snowy"})],ue.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ue.prototype,"cloudCover",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ue.prototype,"precipitation",void 0),d([v({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],ue.prototype,"snowCover",void 0),ue=Ot=d([z("esri.views.3d.environment.SnowyWeather")],ue);var Pt;let je=Pt=class extends Fe{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new Pt({cloudCover:this.cloudCover})}};d([Ee({sunny:"sunny"})],je.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],je.prototype,"cloudCover",void 0),je=Pt=d([z("esri.views.3d.environment.SunnyWeather")],je);const Be=1e4,Ns=1e5;class Gs{constructor(){this.startTime=0,this._data=ht(null),this._readChannels=tt.RG,this.parallax=new ar,this.parallaxNew=new ar,this._anchorPoint=Me(),this._fadeState=ht(f.HIDE),this._fadeFactor=ht(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case f.HIDE:return 0;case f.FADE_OUT:return 1-this.fadeFactor;case f.FADE_IN:return this.fadeFactor;case f.SHOW:case f.CROSS_FADE:return 1}}fade(e,r,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?Sr((r-this.startTime)/(Vs*i),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,r),this._updateParallax(e)}_evaluateState(e,r){const i=e.relativeElevation,s=this._updateAnchorPoint(e);(i>1.7*Be||i<-Be||s>or)&&this.opacity>0?this._startFade(f.HIDE,r):this.isFading||(i>Be||i<-.35*Be||s>zs*or?this.opacity>0&&this._startFade(f.FADE_OUT,r):Hs(this.data)&&(this.opacity===0?this._startFade(f.FADE_IN,r):this.data.state===j.Ready&&(this.fadeState===f.SHOW?this._startFade(f.CROSS_FADE,r):this._startFade(f.SHOW,r))))}_updateParallax(e){const r=Qr(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(r-Ye.radius*Ye.radius,0))/Math.sqrt(r),Jt(nr,this.parallax.anchorPoint,ge),Nt(this.parallax.transform,ie,ge[3],Zt(ge)),Jt(nr,this.parallaxNew.anchorPoint,ge),Nt(this.parallaxNew.transform,ie,ge[3],Zt(ge))}_updateAnchorPoint(e){var r;return Xr(this._anchorPoint,e.eye),Yr(this._anchorPoint,this._anchorPoint,Ye.radius),this.fadeState===f.HIDE&&((r=this.data)==null?void 0:r.state)===j.Ready?(U(this.parallax.anchorPoint,this._anchorPoint),0):Jr(Zr(Ws,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,r){switch(this._fadeState.value=e,this.startTime=r,e){case f.CROSS_FADE:this.requestFade(),this._switchReadChannels(),U(this.parallaxNew.anchorPoint,this._anchorPoint);break;case f.FADE_IN:this.requestFade(),this._switchReadChannels(),U(this.parallax.anchorPoint,this._anchorPoint),U(this.parallaxNew.anchorPoint,this._anchorPoint);break;case f.FADE_OUT:this.requestFade();break;case f.SHOW:this._switchReadChannels(),U(this.parallax.anchorPoint,this._anchorPoint),U(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case f.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==j.Ready&&(this.data.state=j.Idle),this.fadeState){case f.CROSS_FADE:U(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=f.SHOW;break;case f.FADE_IN:this._fadeState.value=f.SHOW;break;case f.FADE_OUT:this._fadeState.value=f.HIDE;break;case f.SHOW:case f.HIDE:break;default:Kr(this.fadeState)}}_switchReadChannels(){var e;((e=this.data)==null?void 0:e.state)===j.Ready&&(this._readChannels=1-this._readChannels,this.data.state=j.Fading)}get isFading(){return this.fadeState===f.FADE_OUT||this.fadeState===f.FADE_IN||this.fadeState===f.CROSS_FADE}}var f;(function(t){t[t.HIDE=0]="HIDE",t[t.FADE_IN=1]="FADE_IN",t[t.SHOW=2]="SHOW",t[t.CROSS_FADE=3]="CROSS_FADE",t[t.FADE_OUT=4]="FADE_OUT"})(f||(f={}));let ar=class{constructor(){this.anchorPoint=Me(),this.radiusCurvatureCorrection=0,this.transform=N()}};const nr=It(0,0,1),ge=Ts(),Ws=Me(),Vs=1.25,zs=.5,or=2e5;let qs=class extends Fi{constructor(e,r){super(e,"samplerCube",bs.Pass,(i,s,a)=>i.bindTexture(e,r(s,a)))}};function dn(t){const e=t.fragment;e.constants.add("radiusCloudsSquared","float",Us).code.add(C`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),e.uniforms.add(new ne("radiusCurvatureCorrection",(o,h)=>h.clouds.parallax.radiusCurvatureCorrection)).code.add(C`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),e.code.add(C`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),Mi(e),Li(e);const r=It(.28,.175,.035);e.constants.add("RIM_COLOR","vec3",r),e.code.add(C`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${C.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${C.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${C.float(.2)} * pow(dirDotLight, ${C.float(10)}) * (1. - pow(sunsetTransition, ${C.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),e.uniforms.add(new jt("readChannelsRG",(o,h)=>h.clouds.readChannels===tt.RG),new qs("cubeMap",(o,h)=>{var g,m;return((m=(g=h.clouds.data)==null?void 0:g.cubeMap)==null?void 0:m.colorTexture)??null})).code.add(C`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = texture(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),e.uniforms.add(new bt("anchorPoint",(o,h)=>h.clouds.parallax.anchorPoint),new bt("anchorPointNew",(o,h)=>h.clouds.parallaxNew.anchorPoint),new Bt("rotationClouds",(o,h)=>h.clouds.parallax.transform),new Bt("rotationCloudsNew",(o,h)=>h.clouds.parallaxNew.transform),new ne("cloudsOpacity",(o,h)=>h.clouds.opacity),new ne("fadeFactor",(o,h)=>h.clouds.fadeFactor),new jt("crossFade",(o,h)=>h.clouds.fadeState===f.CROSS_FADE)).code.add(C`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const Us=(Ye.radius+Ns)**2;var Ce;(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(Ce||(Ce={}));let Gr=class extends Le{constructor(){super(...arguments),this.color=It(1,1,1)}};function js(){const t=new J;return t.include(Et),t.fragment.uniforms.add(new V("tex",e=>e.texture),new bt("uColor",e=>e.color)),t.fragment.main.add(C`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),t}const Bs=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Gr,build:js},Symbol.toStringTag,{value:"Module"}));let Wr=class extends Le{};function ks(){const t=new J,{outputs:e,fragment:r}=t;return t.include(Et),r.uniforms.add(new Hr("textureInput",i=>i.input)),r.constants.add("outlineWidth","int",Math.ceil(rt)),r.constants.add("cellSize","int",se),e.add("fragGrid","vec2"),r.main.add(C`vec2 inputTextureSize = vec2(textureSize(textureInput, 0));
vec2 cellBottomLeftCornerInput = floor(gl_FragCoord.xy) * vec2(cellSize);
vec2 coordMid =  (cellBottomLeftCornerInput + 0.5 * vec2(cellSize)) / inputTextureSize;
vec2 commonValue = texture(textureInput, coordMid).rg;
int margin = outlineWidth;
float marginSquare = float(margin*margin);
for(int y = -margin; y <= cellSize + margin; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : margin;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
vec2 coord = (cellBottomLeftCornerInput + vec2(x, y)) / inputTextureSize;
vec2 value = texture(textureInput, coord).rg;
if (value != commonValue){
fragGrid = vec2(1.0, 1.0);
return;
}
}
}
bool hasAny = commonValue != vec2(0.0);
fragGrid = vec2(hasAny ? 1.0 : 0.0, 0.0);`),t}const se=32,rt=9,Vr=.4,Qs=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Wr,blurSize:Vr,build:ks,gridCellPixelSize:se,outlineSize:rt},Symbol.toStringTag,{value:"Module"}));function nt(t){const{vertex:e}=t;e.uniforms.add(new V("coverageTexture",r=>r.coverageTexture),new kt("highlightRenderCellCount",r=>[r.horizontalCellCount,r.verticalCellCount]),new kt("highlightTextureResolution",r=>[r.highlightTexture.descriptor.width,r.highlightTexture.descriptor.height])),e.constants.add("cellSize","int",se),t.varyings.add("sUV","vec2"),t.varyings.add("vOutlinePossible","float"),e.code.add(C`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),e.main.add(C`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
vec4 cov = texelFetch(coverageTexture, cellPos, 0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = cov.g;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}function it(t){const{fragment:e}=t;e.code.add(C`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(vec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return uint(texel[lic] * 255.0);
}
uint readLevelBits(vec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}function Xs(){const t=new J;t.include(nt);const{fragment:e}=t;return e.uniforms.add(new V("highlightTexture",r=>r.highlightTexture),new V("highlightOptionsTexture",r=>r.highlightOptionsTexture),new ne("pixelRatio",r=>r.pixelRatio),new ne("occludedIntensityFactor",r=>r.occludedFactor),new Ae("maxHighlightLevel",r=>r.maxHighlightLevel)),e.constants.add("pixelSampleScale","float",1),t.include(it),e.code.add(C`const float pascal17[9] = float[9](12870.0, 11440.0, 8008.0, 4368.0, 1820.0, 560.0, 120.0, 16.0, 1.0);
const float denom17 =  65536.0;
float colorWeight[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
float colorOcclusion[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
float weights[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
void applyTexel(vec2 texel, float weight) {
if (texel != vec2(0.0)){
int maxChannel = (maxHighlightLevel >> 2) & 1;
for (int channelIndex = 0; channelIndex <= maxChannel; ++channelIndex){
uint channel = readChannel(texel, channelIndex << 2);
int firstIndex = channelIndex << 2;
int maxIndex  = min(firstIndex + 3, maxHighlightLevel);
for (int highlightIndex = firstIndex; highlightIndex <= maxIndex; ++highlightIndex ) {
uint v = readChannelBits(channel, highlightIndex);
if ((v & 1u) == 1u){
colorWeight[highlightIndex] += weight;
if ((v & 2u) == 2u){
colorOcclusion[highlightIndex] += weight;
}
}
}
}
}
}
vec2 readTexel(ivec2 iuv, int du, int dv) {
return texelFetch(highlightTexture, iuv + ivec2(du, dv), 0).rg;
}
void readAndApplyTexel(ivec2 iuv, int du, int dv, float weight) {
vec2 texel = readTexel(iuv, du, dv);
applyTexel(texel, weight);
}
void readAndApply2TexelsU(ivec2 iuv, int du, int dv, float weight) {
readAndApplyTexel(iuv, -du, dv, weight);
readAndApplyTexel(iuv, +du, dv, weight);
}
float getWeight(int pixelDistance) {
float scaledDistance = float(pixelDistance) * pixelSampleScale / pixelRatio;
float d0f = floor(scaledDistance);
int d0 = int(d0f);
if (d0 >= 8){
return 0.0;
}
float w0 = pascal17[d0];
float w1 = pascal17[d0+1];
float f =  scaledDistance - d0f;
return mix(w0, w1, f);
}`),e.main.add(C`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
ivec2 iuv = ivec2(sUV * highlightTextureSize);
vec2 centerTexel = texelFetch(highlightTexture, iuv, 0).rg;
bool outlinePossible = false;
if (vOutlinePossible > 0.0){
for (int highlightLevel=0; highlightLevel<= maxHighlightLevel; ++highlightLevel) {
if ((readLevelBits(centerTexel,highlightLevel) & 1u) == 0u) {
outlinePossible = true;
break;
}
}
}
if (outlinePossible) {
int maxPixelDistance = clamp(int(8.0 * pixelRatio / pixelSampleScale), 2, 16);
float weightSum = 0.0;
for(int y = 0; y <= maxPixelDistance; ++y) {
float w = getWeight(y);
weights[y] = w;
weightSum += w * (y == 0 ? 1.0 : 2.0);
}
for(int y = 0; y <= maxPixelDistance; ++y) {
weights[y] = weights[y] / weightSum;
}
float weight0 = weights[0];
applyTexel(centerTexel, weight0 * weight0);
for(int y = 0; y <= maxPixelDistance; y += 1) {
float yFactor = weights[y];
if (y != 0) {
float xFactor = weight0;
float weight = xFactor * yFactor;
if (weight > 0.0) {
readAndApplyTexel(iuv, 0, +y, weight);
readAndApplyTexel(iuv, 0, -y, weight);
}
}
for(int x = 1; x <= maxPixelDistance; x += 1) {
float xFactor = weights[x];
float weight = xFactor * yFactor;
if (weight > 0.0) {
readAndApply2TexelsU(iuv, x, +y, weight);
if (y != 0){
readAndApply2TexelsU(iuv, x, -y, weight);
}
}
}
}
} else {
applyTexel(centerTexel, 1.0);
}
int frontColorIndex = 999;
int maxColorIndex = 0;
for (int i = 0; i <= maxHighlightLevel; ++i) {
if (colorWeight[i] > 0.0){
frontColorIndex = min(frontColorIndex, i);
maxColorIndex = max(maxColorIndex, i);
}
}
if (frontColorIndex == 999){
fragColor = vec4(0.0);
return;
}
vec4 accumulatedColor = vec4(0.0);
for (int curColorIndex = frontColorIndex; curColorIndex <= maxColorIndex; ++curColorIndex) {
float curColorWeight = colorWeight[curColorIndex];
if (curColorWeight <= 0.01){
continue;
}
uint vc = readLevelBits(centerTexel, curColorIndex);
bool centerFilled = (vc & 1u) == 1u;
bool centerOccluded = (vc & 3u) == 3u;
float curColorOcclusion = colorOcclusion[curColorIndex];
bool occluded = centerFilled ? centerOccluded : curColorOcclusion > 0.5 * curColorWeight;
int colorChannel = centerFilled ? 0 : 1;
vec4 colorBase = texelFetch(highlightOptionsTexture, ivec2(curColorIndex, colorChannel), 0);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, 0.03, curColorWeight);
float intensity = colorBase.a * occlusionFactor * outlineFactor;
vec3 currentColor = colorBase.rgb;
float a0 = accumulatedColor.a;
float a1 = intensity;
float alpha = clamp(a0 + a1 - a0 * a1, 0.0, 1.0);
if (alpha > 0.001){
vec3 blendedColor = ((1.0 - a1) * a0 * accumulatedColor.rgb + a1 * currentColor) / alpha;
accumulatedColor = vec4(blendedColor, alpha);
}
}
fragColor = accumulatedColor;`),t}const Ys=Object.freeze(Object.defineProperty({__proto__:null,build:Xs},Symbol.toStringTag,{value:"Module"}));let lr=class extends Z{constructor(e,r,i){super(e,r,new K(Ys,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.H),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}initializePipeline(){return Q({blending:Ft,colorWrite:X})}},hr=class extends Z{constructor(e,r,i){super(e,r,new K(Qs,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.o),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}initializePipeline(){return Q({colorWrite:X})}},Js=class extends Le{constructor(){super(...arguments),this.occludedFactor=ei,this.maxHighlightLevel=1,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};function Zs(){const t=new J;t.include(nt),t.include(it);const{fragment:e}=t;return t.outputs.add("fragSingleHighlight","vec2",0),e.uniforms.add(new V("highlightTexture",r=>r.highlightTexture),new Ae("maxHighlightLevel",r=>r.maxHighlightLevel),new Ae("highlightLevel",r=>r.highlightLevel)),t.include(it),e.main.add(C`ivec2 iuv = ivec2(gl_FragCoord.xy);
vec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),t}const Ks=Object.freeze(Object.defineProperty({__proto__:null,build:Zs},Symbol.toStringTag,{value:"Module"}));let cr=class extends Z{constructor(e,r,i){super(e,r,new K(Ks,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.p),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}initializePipeline(){return Q({colorWrite:X})}};function ea(){const t=new J;t.include(nt);const{fragment:e}=t;return e.uniforms.add(new V("blurInput",r=>r.singleHighlightBlurTexture),new Nr("blurSize",r=>r.blurSize),new V("highlightTexture",r=>r.highlightTexture),new V("highlightOptionsTexture",r=>r.highlightOptionsTexture),new Ae("highlightLevel",r=>r.highlightLevel),new ne("occludedIntensityFactor",r=>r.occludedFactor)),e.constants.add("inner","float",1-(rt-Vr)/rt),t.include(it),e.main.add(C`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
vec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),t}const ta=Object.freeze(Object.defineProperty({__proto__:null,build:ea},Symbol.toStringTag,{value:"Module"}));let dr=class extends Z{constructor(e,r,i){super(e,r,new K(ta,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.r),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}initializePipeline(){return Q({blending:Ft,colorWrite:X})}};class zr extends Le{constructor(){super(...arguments),this.blurSize=w()}}function ra(){const t=new J;return t.include(nt),t.fragment.uniforms.add(new Nr("blurSize",e=>e.blurSize),new Hr("blurInput",e=>e.blurInput)),t.outputs.add("fragSingleHighlight","vec2",0),t.fragment.main.add(C`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
if (vOutlinePossible == 0.0) {
fragSingleHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
fragSingleHighlight = sum;
}`),t}const ia=Object.freeze(Object.defineProperty({__proto__:null,SingleHighlightBlurDrawParameters:zr,build:ra},Symbol.toStringTag,{value:"Module"}));let ur=class extends Z{constructor(e,r,i){super(e,r,new K(ia,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.s),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}initializePipeline(){return Q({colorWrite:X})}};const sa=[];new et(G.POSITION,3,De.FLOAT,0,12);new et(G.POSITION,2,De.FLOAT,0,8);new et(G.POSITION,2,De.FLOAT,0,16),new et(G.UV0,2,De.FLOAT,8,16);let Te=class extends Hi{constructor(e){super(e),this.produces=ut.HIGHLIGHTS,this.consumes={required:[ut.HIGHLIGHTS,"highlights"]},this.useMultipleHighlights=!!Or("enable-feature:multiple-highlights"),this._optionsTexture=null,this._downsampleDrawParameters=new Wr,this._passParameters=new Js,this._singleHighlightBlurDrawParameters=new zr,this._grid=new aa,e.techniques.precompile(hr),this.useMultipleHighlights?e.techniques.precompile(lr):(e.techniques.precompile(cr),e.techniques.precompile(ur),e.techniques.precompile(dr))}initialize(){this.addHandles([Se(()=>Ur(this.view.highlights),()=>{this._optionsTexture=Ie(this._optionsTexture),this.requestRender(Ve.UPDATE)},ti)])}destroy(){this._passParameters&&(this._passParameters.highlightOptionsTexture=null),this._grid.coverage=$e(this._grid.coverage),this._grid.vao=Ie(this._grid.vao),this._optionsTexture=$e(this._optionsTexture)}_updateOptionsTexture(e){const r=this.renderingContext;let i=this._optionsTexture;if(i==null){const s=new Pr(16,2);s.internalFormat=ri.RGBA,s.samplingMode=$r.NEAREST,i=new Ze(r,s,null),this._optionsTexture=i}i.setData(e),this._passParameters.highlightOptionsTexture=i}render(e){const r=e.find(({name:p})=>p===ut.HIGHLIGHTS),{techniques:i,bindParameters:s,_passParameters:a,renderingContext:n}=this;if(!s.decorations)return r;const l=i.acquire(hr);if(!l.compiled)return l.release(),this.requestRender(Ve.UPDATE),r;const o=e.find(({name:p})=>p==="highlights").getTexture(),h=()=>{var le;const{highlights:p}=this.view;this._optionsTexture||this._updateOptionsTexture(na(p)),a.highlightOptionsTexture=this._optionsTexture,this._gridUpdateResources(o);const x=this._gridComputeCoverage(l,o,s);l.release();const{horizontalCellCount:L,verticalCellCount:ee}=x;return a.horizontalCellCount=L,a.verticalCellCount=ee,a.coverageTexture=(le=x.coverage)==null?void 0:le.getTexture(),x},g=p=>{const x=p.verticalCellCount*p.horizontalCellCount;n.bindVAO(p.vao),n.drawElementsInstanced(ii.TRIANGLES,6,De.UNSIGNED_BYTE,0,x)},{camera:m}=s,_=()=>{n.bindFramebuffer(r.fbo),n.setViewport4fv(m.fullViewport)};return this.useMultipleHighlights?this._renderMultiple(o,h,g,_):this._renderSingle(o,h,g,_),a.highlightTexture=null,a.coverageTexture=null,r}_renderMultiple(e,r,i,s){const{techniques:a,bindParameters:n,_passParameters:l,renderingContext:o}=this,h=a.acquire(lr);if(!h.compiled)return h.release(),void this.requestRender(Ve.UPDATE);const g=r();l.highlightTexture=e,l.pixelRatio=n.camera.pixelRatio,l.maxHighlightLevel=_r(this.view.highlights)-1,o.bindTechnique(h,n,l),s(),i(g),h.release()}_renderSingle(e,r,i,s){var Lt;const{fboCache:a,techniques:n,bindParameters:l,_passParameters:o,renderingContext:h}=this,g=n.acquire(cr),m=n.acquire(ur),_=n.acquire(dr);if(!_.compiled||!m.compiled||!g.compiled)return _.release(),m.release(),g.release(),void this.requestRender(Ve.UPDATE);const p=r(),{width:x,height:L}=e.descriptor;o.maxHighlightLevel=_r(this.view.highlights)-1,o.highlightTexture=e;const{camera:ee}=l,{fullWidth:le,fullHeight:ot,pixelRatio:He}=ee,he=Math.ceil(le/He),y=Math.ceil(ot/He),{_singleHighlightBlurDrawParameters:T}=this;for(let lt=0;lt<=o.maxHighlightLevel;++lt){o.highlightLevel=lt,h.setClearColor(0,0,0,0);const Ne=a.acquire(x,L,"single highlight",W.RG);h.bindFramebuffer(Ne.fbo),h.setViewport(0,0,x,L),h.clear(oe.COLOR),h.bindTechnique(g,l,o),i(p),T.blurInput=Ne.getTexture(),ae(T.blurSize,1/he,0);const Ge=a.acquire(he,y,"single highlight blur h",W.RG);h.unbindTexture((Lt=Ge.fbo)==null?void 0:Lt.colorTexture),h.bindFramebuffer(Ge.fbo),h.setViewport(0,0,he,y),h.clear(oe.COLOR),T.blurInput=Ne.getTexture(),ae(T.blurSize,1/he,0),h.bindTechnique(m,l,o,T),i(p),Ne.release(),ae(T.blurSize,0,1/y),o.singleHighlightBlurTexture=Ge.getTexture(),s(),h.bindTechnique(_,l,o,T),i(p),Ge.release()}g.release(),m.release(),_.release()}_gridUpdateResources(e){const r=this.renderingContext,i=this._grid,{width:s,height:a}=e.descriptor;if(i.horizontalCellCount=Math.ceil(s/se),i.verticalCellCount=Math.ceil(a/se),i.vao)return;const n=Kt.createIndex(r,Gt.STATIC_DRAW,la);i.vao=new fs(r,Ni,new Map([["geometry",sa]]),new Map([["geometry",Kt.createVertex(r,Gt.STATIC_DRAW)]]),n)}_gridComputeCoverage(e,r,i){var g;const s=this.renderingContext,a=this._grid,n=r.descriptor,l=Math.ceil(n.width/se),o=Math.ceil(n.height/se);this._downsampleDrawParameters.input=r,(g=a.coverage)==null||g.release();const h=this.fboCache.acquire(l,o,"highlight coverage",W.RG);return a.coverage=h,s.bindFramebuffer(h.fbo),s.bindTechnique(e,i,this._passParameters,this._downsampleDrawParameters),s.setViewport(0,0,l,o),s.screen.draw(),a}get test(){}};d([v()],Te.prototype,"produces",void 0),d([v()],Te.prototype,"consumes",void 0),d([v({constructOnly:!0})],Te.prototype,"techniques",void 0),Te=d([z("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Te);class aa{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}function na(t){const e=new Uint8Array(128),r=(s,a)=>{e[s]=a},i=(s,a)=>{const n=4*s,l=4*s+64,{color:o}=a,h=a.haloColor??o;r(n+0,o.r),r(n+1,o.g),r(n+2,o.b),r(n+3,a.fillOpacity*o.a*255),r(l+0,h.r),r(l+1,h.g),r(l+2,h.b),r(l+3,a.haloOpacity*h.a*255)};return qr(t,(s,a)=>{i(a,s.options)}),e}const gr=new Array(k),pr=new Array(k);function qr(t,e){const r=Math.min(t.length,k);let i=k;for(let a=r-1;a>=0;--a){const n=t.at(a);if(n){const l=n.name;gr.includes(l,i)||(--i,gr[i]=l,pr[i]=a)}}const s=k-i;for(let a=0;a<s;++a){const n=pr[k-s+a];e(t.at(n),a)}}let oa=0;function Ur(t){let e=0;const r=Math.min(k,t.length);for(let i=0;i<r;++i){const s=t.at(i);if(s){const{name:a,options:n}=s;e+=a.length;const{color:l,fillOpacity:o,haloColor:h,haloOpacity:g}=n;e+=l.r+((h==null?void 0:h.r)??1)+o+g}}{const i=t.at(0);if(i){const{shadowOpacity:s,shadowDifference:a,shadowColor:n}=i.options;e+=s+a+n.r}}return oa+++(e>=0?0:1)}const la=new Uint8Array([0,1,2,2,1,3]);function ha(t,e,r,i,s,a,n=0,l){const{highlightGroupIndices:o}=s;o.clear();const h=[];qr(i,x=>{const{name:L}=x;o.set(L,h.length),h.push(L)});const g=o.size,{gl:m}=t;ae(s.highlightMixOrigin,n,0);let _=null;g>1&&(_=e.acquire(r.width,r.height,"highlight mix",W.RG),t.bindFramebuffer(_.fbo),t.clearFramebuffer(Dr));const p=(_==null?void 0:_.getTexture())??null;s.highlightMixTexture=p,l();for(let x=0;x<g;++x)x>0&&(t.bindTexture(p,0),m.copyTexSubImage2D(Ir.TEXTURE_2D,0,0,0,n,0,r.width,r.height),t.bindTexture(null,0)),t.clear(oe.DEPTH),s.highlightLevel=x,s.highlightGroupName=h[x],a();_==null||_.release()}function _r(t){var r;const e=new Set;for(let i=0;i<k;++i){const s=(r=t.at(i))==null?void 0:r.name;s&&e.add(s)}return e.size}let ca=class{constructor(e,r,i,s){this._textures=e,this._techniques=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new Ss}dispose(){this._textures.destroy()}acquire(e,r,i){this._ownMaterial(e);const s=e.produces.get(r);if(!(s!=null&&s(i)))return null;let a=this._id2glMaterialRef.get(i,e.id);if(a==null){const n=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:i});a=new da(n),this._id2glMaterialRef.set(i,e.id,a)}return a.ref(),a.glMaterial}release(e,r){const i=this._id2glMaterialRef.get(r,e.id);i!=null&&(i.unref(),i.referenced||(Ie(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&si.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},da=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ye(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var st;(function(t){t[t.Immediate=0]="Immediate",t[t.FadeWithWeather=1]="FadeWithWeather"})(st||(st={}));let ua=class{constructor(e){this.shadowMap=e,this.slot=P.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=Ke.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new at,this._inverseViewport=w(),this._oldLighting=new gt,this._newLighting=new gt,this._fadedLighting=new gt,this._lighting=this._newLighting,this.ssr=new ga,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlightMixTexture=null,this.highlightGroupName=null,this.highlightGroupIndices=new Map,this.highlightLevel=0,this.highlightMixOrigin=w(),this.hudRenderStyle=Ps.Occluded,this.clouds=new Gs,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,r,i,s){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=i,this._newLighting.set(e),s===st.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}};class ga{constructor(){this.fadeFactor=1,this.reprojectionMatrix=N()}}let pa=class{constructor(e,r){this.rctx=e,this.lastFrameCamera=new at,this.output=S.Color,this.renderOccludedMask=Je,this.bind=new ua(r),this.bind.alignPixelEnabled=!0}};const Je=Pe.Occlude|Pe.OccludeAndTransparent|Pe.OccludeAndTransparentStencil;let Oe=class extends at{constructor(){super(...arguments),this._projectionMatrix=N()}get projectionMatrix(){return this._projectionMatrix}};d([v()],Oe.prototype,"_projectionMatrix",void 0),d([v({readOnly:!0})],Oe.prototype,"projectionMatrix",null),Oe=d([z("esri.views.3d.webgl-engine.lib.CascadeCamera")],Oe);var $t;(function(t){t[t.Highlight=0]="Highlight",t[t.ExcludeHighlight=1]="ExcludeHighlight"})($t||($t={}));class ke{constructor(){this.camera=new Oe,this.lightMat=N()}}class _a{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class ma{constructor(e,r){this._fbos=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new _a,this._projectionView=N(),this._projectionViewInverse=N(),this._modelViewLight=N(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=At(),this._cascades=[new ke,new ke,new ke,new ke],this._lastOrigin=null,this._maxTextureWidth=Math.min(Or("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Wt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=$e(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Sr(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)vt[e]=this._cascades[e];return vt.length=this._numCascades,vt}start(e,r,i,s,a){ye(this.enabled);const{near:n,far:l}=wa(i);this._computeCascadeDistances(n,l,s),this._textureHeight=this._computeTextureHeight(e,a,s),this._setupMatrices(e,r);const{viewMatrix:o,projectionMatrix:h}=e;for(let g=0;g<this._numCascades;++g)this._constructCascade(g,h,o,r);this._lastOrigin=null,this.clear()}finish(){var e;ye(this.enabled),(e=this._handle)==null||e.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!ai(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||Me(),U(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){Vt(Cr,this._cascades[r].lightMat,e);for(let i=0;i<16;++i)wr[16*r+i]=Cr[i]}}return wr}moveSnapshot(e){var r,i;ye(this.enabled),(r=this._handle)==null||r.detachDepth(),(i=this._snapshots[e])==null||i.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){var o,h,g,m;const r=(h=(o=this._handle)==null?void 0:o.getTexture())==null?void 0:h.descriptor;if(!this.enabled||!r)return;(g=this._snapshots[e])==null||g.release();const{width:i,height:s}=r,a=e===$t.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(i,s,a,W.RGBA4);const n=this._fbos.rctx;this._bindFbo();const l=n.bindTexture((m=this._snapshots[e])==null?void 0:m.getTexture(),Ze.TEXTURE_UNIT_FOR_UPDATES);n.gl.copyTexSubImage2D(Ir.TEXTURE_2D,0,0,0,0,0,i,s),n.bindTexture(l,Ze.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){var r;return this.enabled?(r=this._snapshots[e])==null?void 0:r.getTexture():null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clear(oe.COLOR|oe.DEPTH)}_computeTextureHeight(e,r,i){const s=Math.min(window.devicePixelRatio,r)/e.pixelRatio,a=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,n=Gi(Math.floor(Math.max(e.fullWidth,e.fullHeight)*s*a)),l=Math.min(this._maxTextureWidth,this._numCascades*n);return Wi(l/this._numCascades)}_ensureFbo(){var e,r,i,s,a;((r=(e=this._handle)==null?void 0:e.fbo)==null?void 0:r.width)===this._textureWidth&&((i=this._handle)==null?void 0:i.fbo.height)===this._textureHeight||((s=this._handle)==null||s.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",W.RGBA4)),(a=this._handle)==null||a.acquireDepth(Vi.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=$e(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){var e;this._fbos.rctx.bindFramebuffer((e=this._handle)==null?void 0:e.fbo)}_constructCascade(e,r,i,s){const a=this._cascades[e],n=-this._cascadeDistances[e],l=-this._cascadeDistances[e+1],o=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]),h=(r[10]*l+r[14])/Math.abs(r[11]*l+r[15]);ye(o<h);for(let p=0;p<8;++p){Wt(mr,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?o:h,1);const x=M[p];ni(x,mr,this._projectionViewInverse),x[0]/=x[3],x[1]/=x[3],x[2]/=x[3]}oi(ft,M[0]),a.camera.viewMatrix=Vt(fa,this._modelViewLight,ft);for(let p=0;p<8;++p)Ar(M[p],M[p],a.camera.viewMatrix);let g=M[0][2],m=M[0][2];for(let p=1;p<8;++p)g=Math.min(g,M[p][2]),m=Math.max(m,M[p][2]);g-=200,m+=200,a.camera.near=-m,a.camera.far=-g,Ca(i,s,g,m,a.camera),wt(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const _=this._textureHeight;a.camera.viewport=[e*_,0,_,_]}_setupMatrices(e,r){wt(this._projectionView,e.projectionMatrix,e.viewMatrix),li(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===hi.Global?e.eye:Er(ft,0,0,1);ci(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_computeCascadeDistances(e,r,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Os(r/e,4)),s);const a=(r-e)/this._numCascades,n=(r/e)**(1/this._numCascades);let l=e,o=e;for(let h=0;h<this._numCascades+1;++h)this._cascadeDistances[h]=di(l,o,this.settings.splitSchemeLambda),l*=n,o+=a}get test(){}}const fa=N(),mr=At(),M=[];for(let t=0;t<8;++t)M.push(At());const fr=w(),vr=w(),va=w(),xr=w(),yr=w(),ft=Me(),vt=[],Cr=N(),wr=ie.concat(ie,ie,ie,ie),E=w(),pe=w(),re=[w(),w(),w(),w()],R=w(),xt=w(),q=w(),Re=w(),_e=w(),me=w(),Qe=w();function xa(t,e,r,i,s,a,n,l){ae(E,0,0);for(let y=0;y<4;++y)te(E,E,t[y]);fe(E,E,.25),ae(pe,0,0);for(let y=4;y<8;++y)te(pe,pe,t[y]);fe(pe,pe,.25),we(re[0],t[4],t[5],.5),we(re[1],t[5],t[6],.5),we(re[2],t[6],t[7],.5),we(re[3],t[7],t[4],.5);let o=0,h=zt(re[0],E);for(let y=1;y<4;++y){const T=zt(re[y],E);T<h&&(h=T,o=y)}ve(R,re[o],t[o+4]);const g=R[0];let m,_;R[0]=-R[1],R[1]=g,ve(xt,pe,E),O(xt,R)<0&&gi(R,R),we(R,R,xt,r),qt(R,R),m=_=O(ve(q,t[0],E),R);for(let y=1;y<8;++y){const T=O(ve(q,t[y],E),R);T<m?m=T:T>_&&(_=T)}pi(i,E),fe(q,R,m-e),te(i,i,q);let p=-1,x=1,L=0,ee=0;for(let y=0;y<8;++y){ve(Re,t[y],i),qt(Re,Re);const T=R[0]*Re[1]-R[1]*Re[0];T>0?T>p&&(p=T,L=y):T<x&&(x=T,ee=y)}ce(p>0,"leftArea"),ce(x<0,"rightArea"),fe(_e,R,m),te(_e,_e,E),fe(me,R,_),te(me,me,E),Qe[0]=-R[1],Qe[1]=R[0];const le=ze(i,t[ee],me,te(q,me,Qe),1,s),ot=ze(i,t[L],me,q,1,a),He=ze(i,t[L],_e,te(q,_e,Qe),1,n),he=ze(i,t[ee],_e,q,1,l);ce(le,"rayRay"),ce(ot,"rayRay"),ce(He,"rayRay"),ce(he,"rayRay")}function u(t,e){return 3*e+t}const br=w();function A(t,e){return ae(br,t[e],t[e+3]),br}const $=w(),c=_i();function ya(t,e,r,i,s){ve($,r,i),fe($,$,.5),c[0]=$[0],c[1]=$[1],c[2]=0,c[3]=$[1],c[4]=-$[0],c[5]=0,c[6]=$[0]*$[0]+$[1]*$[1],c[7]=$[0]*$[1]-$[1]*$[0],c[8]=1,c[u(0,2)]=-O(A(c,0),t),c[u(1,2)]=-O(A(c,1),t);let a=O(A(c,0),r)+c[u(0,2)],n=O(A(c,1),r)+c[u(1,2)],l=O(A(c,0),i)+c[u(0,2)],o=O(A(c,1),i)+c[u(1,2)];a=-(a+l)/(n+o),c[u(0,0)]+=c[u(1,0)]*a,c[u(0,1)]+=c[u(1,1)]*a,c[u(0,2)]+=c[u(1,2)]*a,a=1/(O(A(c,0),r)+c[u(0,2)]),n=1/(O(A(c,1),r)+c[u(1,2)]),c[u(0,0)]*=a,c[u(0,1)]*=a,c[u(0,2)]*=a,c[u(1,0)]*=n,c[u(1,1)]*=n,c[u(1,2)]*=n,c[u(2,0)]=c[u(1,0)],c[u(2,1)]=c[u(1,1)],c[u(2,2)]=c[u(1,2)],c[u(1,2)]+=1,a=O(A(c,1),e)+c[u(1,2)],n=O(A(c,2),e)+c[u(2,2)],l=O(A(c,1),r)+c[u(1,2)],o=O(A(c,2),r)+c[u(2,2)],a=-.5*(a/n+l/o),c[u(1,0)]+=c[u(2,0)]*a,c[u(1,1)]+=c[u(2,1)]*a,c[u(1,2)]+=c[u(2,2)]*a,a=O(A(c,1),e)+c[u(1,2)],n=O(A(c,2),e)+c[u(2,2)],l=-n/a,c[u(1,0)]*=l,c[u(1,1)]*=l,c[u(1,2)]*=l,s[0]=c[0],s[1]=c[1],s[2]=0,s[3]=c[2],s[4]=c[3],s[5]=c[4],s[6]=0,s[7]=c[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=c[6],s[13]=c[7],s[14]=0,s[15]=c[8]}function Ca(t,e,r,i,s){const a=1/M[0][3],n=1/M[4][3];ye(a<n);let l=a+Math.sqrt(a*n);const o=Math.sin(ui(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));l/=o,xa(M,l,o,fr,vr,va,xr,yr),ya(fr,vr,xr,yr,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function wa(t){let{near:e,far:r}=t;return e<2&&(e=2),r<2&&(r=2),e>=r&&(e=2,r=4),{near:e,far:r}}class ba extends $s{constructor(e,r,i){super(e,r),this.triangleNr=i}}let F=class extends mi{constructor(t){super(t),this._pending=new Ta,this._changes=new vs,this._renderers=new Map,this._sortedRenderers=new Fr,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const t of this._renderers.values())if(t.numGeometries!==0&&!t.queryRenderOccludedState(Pe.Occlude))return!0;return!1}get isEmpty(){return!this.updating&&this._renderers.size===0&&this._geometries.size===0}getMaterialRenderer(t){return this._renderers.get(t)}get sortedRenderers(){return this._sortedRenderers}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const t=xs(this._changes);let e=!1;return t.forEach((r,i)=>{let s=this._renderers.get(i);!s&&r.adds.length>0&&(s=new ys({material:i}),s.initializeRenderContext(this.rendererContext.pluginContext,this._materials),this._renderers.set(i,s),e=!0),s&&(s.modify(r),s.numGeometries===0&&(this._renderers.delete(i),s.destroy(),e=!0))}),this._changes.clear(),e&&this._updateSortedMaterialRenderers(),this._hasHighlights=xe(this._renderers,r=>{const i=r.produces.get(P.DRAPED_MATERIAL);return!!i&&i(S.Highlight)}),this._hasWater=xe(this._renderers,r=>{const i=r.produces.get(P.DRAPED_WATER);return!!i&&i(S.Normal)}),this.notifyChange("updating"),!0}addGeometries(t,e){if(t.length===0)return;const r=this._validateRenderGeometries(t);for(const s of r)this._geometries.set(s.id,s);const i=this._pending.empty;for(const s of r)this._pending.adds.add(s);i&&this.notifyChange("updating"),e===Yt.UPDATE&&this._notifyGraphicGeometryChanged(t)}removeGeometries(t,e){const r=this._pending.empty,i=this._pending.adds;for(const s of t)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);r&&!this._pending.empty&&this.notifyChange("updating"),e===Yt.UPDATE&&this._notifyGraphicGeometryChanged(t)}modifyGeometries(t,e){const r=this._changes.updates.length===0;for(const i of t){const s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(i),s.updateType=e}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),e){case mt.TRANSFORMATION:case mt.GEOMETRY:return this._notifyGraphicGeometryChanged(t);case mt.VISIBILITY:return this._notifyGraphicVisibilityChanged(t)}}updateAnimation(t){let e=!1;return this._sortedRenderers.forAll(r=>e=!!r.updateAnimation&&r.updateAnimation(t)||e),e}precompile(t){return this._sortedRenderers.reduce((e,r)=>r.precompile(t)||e,!1)}render(t){this._sortedRenderers.forAll(e=>{const r=e.acquireTechniques(t);r&&(e.render(t,r),Cs(r))})}intersect(t,e,r,i,s){for(const a of this._geometries.values()){if(!i(a))continue;this._intersectRenderGeometry(a,r,e,0,t,s);const n=this.rendererContext.longitudeCyclical;n&&(a.boundingSphere[0]-a.boundingSphere[3]<n.min&&this._intersectRenderGeometry(a,r,e,n.range,t,s),a.boundingSphere[0]+a.boundingSphere[3]>n.max&&this._intersectRenderGeometry(a,r,e,-n.range,t,s)),s++}return s}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let t=0;for(const e of this._renderers.values())e.drapedPriority=t++,this._sortedRenderers.push(e);this._sortedRenderers.sort((e,r)=>{var i,s,a,n;return((i=r.material)==null?void 0:i.renderPriority)===((s=e.material)==null?void 0:s.renderPriority)?e.drapedPriority-r.drapedPriority:(((a=r.material)==null?void 0:a.renderPriority)||0)-(((n=e.material)==null?void 0:n.renderPriority)||0)})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace(({renderGeometry:t})=>!this._pending.has(t)),this._pending.clear()}_intersectRenderGeometry(t,e,r,i,s,a){if(!t.visible||!t.material.visible)return;let n=0;i+=t.transformation[12],n=t.transformation[13],yt[0]=r[0]-i,yt[1]=r[1]-n,t.screenToWorldRatio=this.rendererContext.screenToWorldRatio,t.material.intersectDraped(t,null,s,yt,(l,o,h)=>{Ra(e,h,a,t.material.renderPriority,s,t.layerUid,t.graphicUid)},e)}_notifyGraphicGeometryChanged(t){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let e;for(const{graphicUid:r}of t)r!=null&&r!==e&&(this.drapeSource.notifyGraphicGeometryChanged(r),e=r)}_notifyGraphicVisibilityChanged(t){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let e;for(const{graphicUid:r}of t)r!=null&&r!==e&&(this.drapeSource.notifyGraphicVisibilityChanged(r),e=r)}_validateRenderGeometries(t){for(const e of t)this._validateRenderGeometry(e);return t}_validateRenderGeometry(t){return t.localOrigin==null&&(t.localOrigin=this._localOriginFactory.getOrigin(Mr(t.boundingSphere))),t}get test(){}};d([v()],F.prototype,"drapeSource",void 0),d([v()],F.prototype,"updating",null),d([v()],F.prototype,"rctx",null),d([v({constructOnly:!0})],F.prototype,"rendererContext",void 0),d([v()],F.prototype,"_materials",null),d([v()],F.prototype,"_localOriginFactory",null),d([v({readOnly:!0})],F.prototype,"isEmpty",null),d([v()],F.prototype,"_renderers",void 0),d([v()],F.prototype,"_geometries",void 0),F=d([z("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],F);class Ta{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function Ra(t,e,r,i,s,a,n){const l=new ba(a,n,e),o=h=>{h.set(Is.OVERLAY,l,t.dist,t.normal,t.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&o(s.results.min),s.options.store!==er.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&o(s.results.max),s.options.store===er.ALL){const h=Ds(s.ray);o(h),s.results.all.push(h)}}const yt=w();class Tr extends Z{constructor(e,r,i){super(e,r,new K(Bs,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.T),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}initializePipeline(e){return e.hasAlpha?Q({blending:Ft,colorWrite:X}):Q({colorWrite:X})}}class jr extends zi{constructor(){super(...arguments),this.hasAlpha=!1}}d([D()],jr.prototype,"hasAlpha",void 0);let Br=class extends Le{constructor(){super(...arguments),this.overlayIndex=B.INNER,this.opacity=1}};function Sa(){const t=new J;return t.include(Et),t.fragment.uniforms.add(new V("tex",e=>e.texture)),t.fragment.uniforms.add(new Ae("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new ne("opacity",e=>e.opacity)),t.fragment.main.add(C`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),t}const Oa=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Br,build:Sa},Symbol.toStringTag,{value:"Module"}));class Rr extends Z{constructor(e,r,i){super(e,r,new K(Oa,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.u),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}}let H=class extends ws{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Br,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Fr,this._passParameters=new Gr,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new at,this.worldToPCSRatio=1,this.events=new fi,this.longitudeCyclical=null,this.produces=new Map([[P.DRAPED_MATERIAL,e=>e!==S.Highlight||this.hasHighlights],[P.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const{view:t}=this,{_stage:e}=t,r=e.renderer.fboCache,i=e.renderView,{waterTextures:s,textures:a}=i;this._renderContext=new pa(this._rctx,new ma(r,t.state.viewingMode)),this.addHandles([Se(()=>s.updating,()=>this.events.emit("content-changed"),ct),Se(()=>this.spatialReference,o=>this._localOriginFactory=new Ii(o),ct),vi(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),Se(()=>Ur(this.view.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,ct)]),this._materials=new ca(a,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));const{_bindParameters:n,_camera:l}=this;n.slot=P.DRAPED_MATERIAL,n.mainDepth=null,l.near=1,l.far=1e4,l.relativeElevation=null,n.camera=this._camera,n.oitPass=Ke.NONE,n.updateLighting([new qi(xi())],0,0,st.Immediate),this.addHandles(this.view.resourceController.scheduler.registerTask(yi.STAGE,this))}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._passParameters.texture=Ie(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this.view._stage.renderView.renderingContext}get _techniques(){return this.view._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(t){this._pluginContext=t,this._techniques.precompile(Rr)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||xe(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(const e of this._renderers.values()){const r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t)}createGeometryDrapeSourceRenderer(t){return this.createDrapeSourceRenderer(t,F)}createDrapeSourceRenderer(t,e,r){const i=this._renderers.get(t);i!=null&&i.destroy();const s=new e({...r,rendererContext:this,drapeSource:t});return this._renderers.set(t,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(Se(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),s}removeDrapeSourceRenderer(t){if(t==null)return;const e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){var t;return((t=this._renderTargets)==null?void 0:t.computeValidity())??0}releaseRenderTargets(){var t;(t=this._renderTargets)==null||t.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&dt(t,e=>e.drapeTargetType===Ei.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=dt(t,e=>e.drapeSourceType===We.Features),this._hasDrapedRasterSource=dt(t,e=>e.drapeSourceType===We.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Ls(this.view._stage.renderer.fboCache),this._overlays=[new ir,new ir]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=Ie(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){var e,r;if(t!=null)return t===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?(e=this._renderTargets)==null?void 0:e.getTexture(b.Color):(r=this._renderTargets)==null?void 0:r.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(const[i,s]of this._renderers){if(t.done)break;(i.destroyed||e(i))&&s.commitChanges()&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=xe(this._renderers,i=>i.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ci,t=>t.updatePolicy===Ai.SYNC)}get isEmpty(){return!pt.OVERLAY_DRAW_DEBUG_TEXTURE&&!xe(this._renderers,t=>!t.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const t=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Ct,++this._techniques.precompiling;const e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=t,e}renders(t){if(pt.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==b.Occluded&&t!==b.Highlight)return!0;++this._techniques.precompiling;const e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,e}get mode(){var t,e;return this.isEmpty?Ce.Disabled:(t=this._renderTargets)!=null&&t.getTexture(b.WaterNormal)?Ce.EnabledWithWater:(e=this._renderTargets)!=null&&e.getTexture(b.Color)?Ce.Enabled:Ce.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(t){if(this._renderTargets){this._bindParameters.alignPixelEnabled=t.alignPixelEnabled,this._bindParameters.highlightGroupName=null,++this._techniques.precompiling;for(const e of this._renderTargets.targets){if(e.content===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=e.output;this._renderContext.output=r,this._bindParameters.slot=r===S.Normal?P.DRAPED_WATER:P.DRAPED_MATERIAL,e.content===b.Occluded&&(this._renderContext.renderOccludedMask=Ct),this._sortedRenderers.forAll(({drapeSource:i,renderer:s})=>{e.content===b.ColorNoRasterImage&&i.drapeSourceType===We.RasterImage||s.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=Je}--this._techniques.precompiling}}drawOverlays(t){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryView();this._bindParameters.alignPixelEnabled=t.alignPixelEnabled;for(const e of this._renderTargets.targets){if(e.content===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(B.INNER,e,t),i=this._drawTarget(B.OUTER,e,t);(r||i)&&e.fbo.generateMipMap()}}}_drawTarget(t,e,r){const i=this._overlays[t],s=i.canvasGeometries;if(s.numViews===0)return!1;const{contentPixelRatio:a}=r;this._screenToWorldRatio=a*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const n=e.output;if(this.isEmpty||n===S.Normal&&!this.hasWater||!i.hasSomeSizedView())return!1;const{_rctx:l,_bindParameters:o}=this;if(this._camera.pixelRatio=i.pixelRatio*a,this._renderContext.output=n,o.screenToWorldRatio=this._screenToWorldRatio,o.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,o.slot=n===S.Normal?P.DRAPED_WATER:P.DRAPED_MATERIAL,e.content===b.Occluded&&(this._renderContext.renderOccludedMask=Ct),o.highlightGroupName=null,!this.renders(e.content))return this._renderContext.renderOccludedMask=Je,!1;const{resolution:h}=i,g=t===B.INNER?0:h;if(l.setViewport(g,0,h,h),this._bindTargetFBO(e),t===B.INNER&&(l.setClearColor(0,0,0,0),l.clear(oe.COLOR)),pt.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==b.Occluded&&e.content!==b.Highlight){this._techniques.precompile(Tr,Dt);const m=this._techniques.acquire(Tr,Dt);for(let _=0;_<s.numViews;_++)this._setViewParameters(s.extents[_],i),this._ensureDebugPatternResources(i.resolution,$a[t]),l.bindTechnique(m,o,this._passParameters),l.screen.draw();m.release()}if(e.output===S.Highlight){const{fboCache:m}=this.view._stage.renderer,_=this._resolution;ha(l,m,{width:_,height:_},this.view.highlights,o,()=>this._renderAllGeometry(t,e),g,()=>this._bindTargetFBO(e))}else this._renderAllGeometry(t,e);return l.bindFramebuffer(null),this._renderContext.renderOccludedMask=Je,!0}_renderAllGeometry(t,e){const r=this._overlays[t],i=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:s,renderer:a})=>{if(e.content===b.ColorNoRasterImage&&s.drapeSourceType===We.RasterImage)return;const{fullOpacity:n}=s,l=n!=null&&n<1&&e.output===S.Color&&this._bindTemporaryFBO();for(let o=0;o<i.numViews;o++)this._setViewParameters(i.extents[o],r),a.render(this._renderContext);if(l){this._bindTargetFBO(e),this._overlayParameters.texture=l.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=t;const o=this._techniques.acquire(Rr);this._rctx.bindTechnique(o,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release(),l.release()}})}_bindTargetFBO(t){const e=this._resolution,r=2*e;t.fbo.bind(this._rctx,r,e)}_bindTemporaryFBO(){const t=this._resolution,e=2*t,r=this.view._stage.renderer.fboCache,i=r.acquire(e,t,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(oe.COLOR),i}get _resolution(){var t;return((t=this._overlays)==null?void 0:t[B.INNER].resolution)??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,i){var a;this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:n}of this._sortedRenderers)s=((a=n.intersect)==null?void 0:a.call(n,t,e,r,i,s))??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const t=this.view.map.allLayers,e=t.length;this._renderers.forEach((r,i)=>{const s=t.indexOf(i.layer),a=s>=0,n=i.renderGroup??(a?Ut.MapLayer:Ut.ViewLayer),l=e*n+(a?s:0);this._sortedRenderers.push(new Pa(i,r,l))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(t,e){const r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],wi(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),bi(r.viewMatrix,[-t[0],-t[1],0])}_updateHasWater(){const t=xe(this._renderers,e=>e.hasWater);t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water"))}_ensureDebugPatternResources(t,e){if(Er(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;const r=new Uint8Array(t*t*4);let i=0;for(let a=0;a<t;a++)for(let n=0;n<t;n++){const l=Math.floor(n/10),o=Math.floor(a/10);l<2||o<2||10*l>t-20||10*o>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&l&&1&o?1&n^1&a?0:255:1&l^1&o?0:128)}const s=new Pr(t);s.samplingMode=$r.NEAREST,this._passParameters.texture=new Ze(this._rctx,s,r)}get test(){}};d([v()],H.prototype,"hasHighlights",void 0),d([v()],H.prototype,"_sortedDrapeSourceRenderersDirty",void 0),d([v({constructOnly:!0})],H.prototype,"view",void 0),d([v({readOnly:!0})],H.prototype,"_techniques",null),d([v()],H.prototype,"worldToPCSRatio",void 0),d([v()],H.prototype,"spatialReference",void 0),d([v({type:Boolean,readOnly:!0})],H.prototype,"updating",null),d([v()],H.prototype,"isEmpty",null),d([v({readOnly:!0})],H.prototype,"rendersOccludedDraped",null),H=d([z("esri.views.3d.terrain.OverlayRenderer")],H);class Pa{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}}const $a=[[1,.5,.5],[.5,.5,1]],On=-2,Ct=Pe.OccludeAndTransparent,Dt=new jr;Dt.hasAlpha=!0;class Pn{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=N(),this._shaderTransformation=null,this._boundingSphere=null,this.id=Ti(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){Ri(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=N()),wt(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=Si()),Ar(Mr(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*Oi(this.shaderTransformation)),this._boundingSphere):Pi}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightGroup(e){this.geometry.foreachHighlightGroup(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}class Da extends Ui{intersect(e,r,i,s,a,n){return ji(e,i,s,a,void 0,n)}}function Ia(t){const e=new J,{vertex:r,fragment:i,attributes:s,varyings:a}=e;Bi(r,t),e.include(ki,t),e.include(Qi,t),e.include(Xi,t),e.include(Yi,t),e.include(Qt,t),e.include(Ji,t),s.add(G.POSITION,"vec3"),t.vvColor&&s.add(G.COLORFEATUREATTRIBUTE,"float"),a.add("vColor","vec4"),a.add("vpos","vec3");const n=t.terrainDepthTest&&t.output===S.Color;return n&&a.add("depth","float"),r.uniforms.add(new Zi("eColor",l=>l.color)),r.main.add(C`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${t.hasVertexColors?"vColor *= eColor;":t.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${n?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = transformPosition(proj, view, vpos);`),e.include(Qt,t),n&&e.include(Ki,t),i.include(es),i.main.add(C`
    discardBySlice(vpos);
    ${n?"terrainDepthTest(depth);":""}
    vec4 fColor = vColor;
    outputColorHighlightOID(fColor, vpos);`),e}const Aa=Object.freeze(Object.defineProperty({__proto__:null,build:Ia},Symbol.toStringTag,{value:"Module"}));class Ea extends Z{constructor(e,r,i){super(e,r,new K(Aa,()=>Y(()=>import("./ShadedColorMaterial.glsl-BLEA2yV8.js").then(s=>s.v),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),i)}_createPipeline(e,r){const{oitPass:i,output:s,transparent:a,cullFace:n,draped:l,hasOccludees:o,polygonOffset:h,enableOffset:g}=e,m=i===Ke.NONE,_=i===Ke.FrontFace;return Q({blending:s===S.Color&&a?ts(i):null,culling:Rs(n),depthTest:l?null:{func:rs(i)},depthWrite:is(e),drawBuffers:s===S.Depth?{buffers:[$i.NONE]}:ss(i,s),colorWrite:X,stencilWrite:o?as:null,stencilTest:o?r?ns:os:null,polygonOffset:m||_?h?Fa:null:ls(g)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}const Fa={factor:1,units:1};class I extends hs{constructor(){super(...arguments),this.cullFace=Mt.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=cs.None,this.emissionSource=ds.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.vvSize=!1,this.vvOpacity=!1}}d([D({count:Mt.COUNT})],I.prototype,"cullFace",void 0),d([D()],I.prototype,"hasSlicePlane",void 0),d([D()],I.prototype,"hasVertexColors",void 0),d([D()],I.prototype,"transparent",void 0),d([D()],I.prototype,"discardInvisibleFragments",void 0),d([D()],I.prototype,"polygonOffset",void 0),d([D()],I.prototype,"enableOffset",void 0),d([D()],I.prototype,"writeDepth",void 0),d([D()],I.prototype,"hasOccludees",void 0),d([D()],I.prototype,"terrainDepthTest",void 0),d([D()],I.prototype,"cullAboveTerrain",void 0),d([D()],I.prototype,"objectAndLayerIdColorInstanced",void 0),d([D()],I.prototype,"vvColor",void 0),d([D()],I.prototype,"draped",void 0);let $n=class extends Da{constructor(e){super(e,La),this._configuration=new I,this.supportsEdges=!0,this.produces=new Map([[P.OPAQUE_MATERIAL,r=>this._isOpaqueMaterialPass(r)],[P.OPAQUE_MATERIAL_WITHOUT_NORMALS,r=>this._isOpaqueNoSSAODepthPass(r)],[P.TRANSPARENT_MATERIAL,r=>_t(r)&&this._transparent&&this.parameters.writeDepth],[P.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,r=>Xt(r)&&this._transparent&&this.parameters.writeDepth],[P.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,r=>_t(r)&&this._transparent&&!this.parameters.writeDepth],[P.DRAPED_MATERIAL,r=>ms(r)]])}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=r.hasOccludees,this._configuration.oitPass=r.oitPass,this._configuration.enableOffset=r.camera.relativeElevation<us,this._configuration.terrainDepthTest=r.terrainDepthTest,this._configuration.cullAboveTerrain=r.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=Es}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===S.Highlight||_t(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return Xt(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new Ma(e)}createBufferWriter(){const e=As().vec3f(G.POSITION);return Lr()&&e.vec4u8(G.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(G.COLORFEATUREATTRIBUTE):e.vec4u8(G.COLOR),new gs(e)}};class Ma extends ps{beginSlot(e){return this.acquireTechnique(Ea,e)}}class La extends _s{constructor(){super(...arguments),this.color=Dr,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Mt.None,this.draped=!1,this.discardInvisibleFragments=!1}}export{$n as O,Xs as a,ks as b,rt as c,Zs as d,Da as e,ra as f,Pn as g,dn as h,Gr as i,js as j,Br as k,se as l,Sa as m,zr as n,Wr as o,Ia as p,On as r,ea as s,Vr as u};
