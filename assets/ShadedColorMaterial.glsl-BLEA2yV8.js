import{aM as er,W as m,X as K,Y as Oi,aN as tr,Z as Ke,$ as ir,_ as Ze,dL as xi,kT as vt,a_ as Et,bR as ye,aR as x,bo as C,b8 as Fe,b7 as Ge,bj as E,aQ as b,kp as $i,is as Rt,jr as rr,bK as we,aV as V,pT as Ie,az as Re,aA as h,dG as Ti,jq as sr,a$ as Ne,ot as nr,bp as ee,iH as ar,b4 as Z,kQ as or,k1 as Ue,bx as lr,bM as cr,ku as hr,aP as Ft,gm as Je,a6 as z,pH as ot,aJ as he,tV as le,tW as te,pM as dr,jf as ur,oI as pr,ar as _r,vb as qe,oK as lt,oJ as Oe,hE as ie,oc as Ai,je as Ci,ak as gr,oX as yt,u3 as fr,aS as v,kA as wt,hJ as Gt,jh as It,aC as Nt,gR as pe,vc as Ut,vd as Li,j2 as Mi,kx as mr,aw as A,a5 as qt,iV as br,ve as vr,vf as yr,vg as ct,u2 as wr,hA as Pe,vh as Pt,q4 as Ht,qD as Wt,b6 as He,uh as Pr,an as J,pL as St,bk as Sr,tI as Dr,vi as Er,aT as Rr,aU as We,uu as xe,dO as Or,tQ as xr,Q as $r,o1 as kt,vj as Tr,j5 as Bt,iq as Yt,vk as Qt,aX as Ar,hB as Cr,d_ as Lr,a2 as Mr,vl as jr,vm as Vr,ue as H,rc as zr,jg as Xt,kM as Fr,vn as Gr,hL as Ir,iv as Nr,le as ht,qb as Ur,vo as qr,tR as Hr,ko as Wr,bh as kr}from"./index-BdDnxAOC.js";import{I as Br,K as ji}from"./colorUtils-CXI_GYiL.js";import{a as Vi,y as zi,m as Fi,p as Gi,g as Ii}from"./Octree-CHZqCJI3.js";import{l as B,v as Se,p as ke,h as Yr,b as Be,M as Qr,d as Xr}from"./lineSegment-BdB5sSqU.js";import{e as Kr,C as et,b as De,n as Ot,A as xt,W as de,f as Zr,o as Jr,a as dt}from"./RibbonLine.glsl-woeA5PUM.js";import{E as Kt,r as es,d as ts,b as is,c as rs,e as ss,i as ns}from"./HUDMaterial.glsl-tln8Kpvy.js";import{e as I,aq as w,aF as Ni,Q as tt,R as Ui,k as je,o as S,N as ae,S as qi,U as it,V as rt,W as as,_ as j,c as oe,v as Zt,X as os,Y as ut,bi as ls,af as P,p as cs,bj as Jt,f as hs,D as ds,P as us,ac as ps,a6 as _s,a as gs,h as fs,ab as ms,ah as ei,ai as bs,ak as vs,al as ys,aM as ws,as as Ps,K as Ss,ar as Ds,at as Es,A as pt,aw as ti,aH as Rs,b5 as Os,bh as xs,aZ as $s}from"./Geometry-0zkcBCci.js";import{B as Ve,o as Ts,g as ze,c as As,f as Cs}from"./renderState-BKlWY516.js";import{t as Ls}from"./glUtil-Dw6UJ_iI.js";import{H as $t}from"./InterleavedLayout-D4EIJKmV.js";import{t as Hi,o as g,r as ii}from"./interfaces-CJw7Cnm-.js";import{e as p}from"./VertexAttribute-Cq4MnHjR.js";import{E as Ms}from"./BufferObject-CMCaTtYE.js";import{a as y,e as ue}from"./basicInterfaces-CZwQPxTp.js";import{g as Tt,r as Ye,O as Qe,a as js,o as Vs,u as zs,b as Fs,l as Gs,c as Is,d as Ns,s as Us,n as qs,f as Hs,i as Ws,j as ks,k as Bs,m as Ys,p as Qs}from"./ColorMaterial-F0dlOmQ4.js";import{d as Xs,w as Xe,y as Ks,T as Zs,x as Js}from"./dehydratedFeatureUtils-BOLOU81j.js";import{t as en}from"./orientedBoundingBox-CDDAEjLg.js";import{r as tn}from"./SnappingVisualizer-CEf62Vs9.js";import{e as rn,i as sn}from"./IntersectorInterfaces-BgX4KEwK.js";import{n as nn}from"./computeTranslationToOriginAndRotation-BpuGNDNV.js";import{i as an}from"./BufferView-DDmSnYbN.js";import{n as At,l as _t}from"./NormalAttribute.glsl-BvcOWU6V.js";import{o as on}from"./AlphaCutoff-UcccL64p.js";import{s as ln}from"./Util-CMsZAslL.js";import"./BindType-BmZEZMMh.js";let cn=class{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=De.Outline}destroy(){this._destroyResources()}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){var i;this._renderGroup=e;const t=(i=this._resources)==null?void 0:i.layerView;t&&(t.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?this._resources!=null&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?this._resources==null&&this._createResources():this._destroyResources()}_createResources(){var s;this._destroyResources();const e=this._resourceFactory.createResources(),t=new Q({view:this._resourceFactory.view,renderGroup:this._renderGroup}),i=(s=this._resourceFactory.view.basemapTerrain)==null?void 0:s.overlayManager;this._resources={layerView:new Q({view:this._resourceFactory.view,renderGroup:this._renderGroup}),external:e,geometriesAdded:!1},i&&(this._resources.drapeSourceRenderer=i.registerGeometryDrapeSource(t)),this._syncGeometriesToRenderer()}_destroyResources(){var t;if(this._resources==null)return;this._ensureRenderGeometriesRemoved();const e=(t=this._resourceFactory.view.basemapTerrain)==null?void 0:t.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;((e=this._resources)==null?void 0:e.drapeSourceRenderer)!=null&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,Kt.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){var e;((e=this._resources)==null?void 0:e.drapeSourceRenderer)!=null&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,Kt.UPDATE),this._resources.geometriesAdded=!0))}},Q=class extends er(tr){constructor(e){super(e),this.drapeSourceType=Kr.Features,this.updatePolicy=et.SYNC,this.renderGroup=De.Outline}};m([K({constructOnly:!0})],Q.prototype,"view",void 0),m([K({readOnly:!0})],Q.prototype,"drapeSourceType",void 0),m([K()],Q.prototype,"renderGroup",void 0),Q=m([Oi("esri.views.3d.interactive.visualElements.DrapedVisualElementResources")],Q);let Ct=class{get isDecoration(){return this._isDecoration}set isDecoration(e){this._isDecoration=e}constructor(e){this._isDecoration=!1,this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e.view,this._handle=Ke(()=>e.view.ready,t=>{this._resourcesCreated&&(t?this._createResources():this._destroyResources())})}applyProperties(e){let t=!1;for(const i in e)i in this&&(i==="attached"?t=!!e[i]:this[i]=e[i]);this.attached=t}destroy(){this.attached=!1,this._handle.remove()}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources(),this.onAttachedChange(e))}onAttachedChange(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.updateVisibility(this.visible)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}},hn=class{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return this._resources!=null?this._resources.object:null}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view._stage;if(this._resources==null||!e)return;const t=this._resources.object;this._resources.external.forEach(i=>{i.type!==I.Mesh&&i.type!==I.Line&&i.type!==I.Point||e.remove(i)}),t.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer),this._resources.external.forEach(i=>{i.type!==I.Mesh&&i.type!==I.Line&&i.type!==I.Point||e.add(i)})}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,t=e.view,i=t._stage;if(!i)return;const s=new Ot(i,{pickable:!1,updatePolicy:et.SYNC}),n=new xt({castShadow:!1}),a=e.createResources(n,s);a.forEach(c=>{i.add(c),c.type===I.Texture&&c.load(i.renderView.renderingContext)}),i.add(n),s.add(n);const o=e.cameraChanged,l=o?Ke(()=>t.state.camera,c=>o(c),ir):null;this._resources={layer:s,object:n,external:a,cameraHandle:l},this._syncVisible()}_destroyResources(){var t;if(this._resources==null)return;const e=this._resourceFactory.view._stage;e&&(e.remove(this._resources.object),this._resources.layer.destroy(),this._resources.external.forEach(i=>{e.remove(i),i.type===I.Texture&&i.unload()})),this._resources.object.dispose(),(t=this._resources.cameraHandle)==null||t.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncVisible(){this._resources!=null&&(this._resources.object.visible=this._visible)}},Lt=class extends Ct{constructor(e){super(e),this._isDraped=!1,this.object3dResources=new hn(this.createObject3DResourceFactory(e.view)),this.drapedResources=new cn(this.createDrapedResourceFactory(e.view)),this.isDraped=e.isDraped??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}};var O;(function(r){r[r.None=0]="None",r[r.Alpha=1]="Alpha",r[r.PremultipliedAlpha=2]="PremultipliedAlpha",r[r.Depth=3]="Depth",r[r.COUNT=4]="COUNT"})(O||(O={}));class Dt extends Ni{constructor(){super(...arguments),this.blitMode=O.None,this.hasOpacityFactor=!1}}m([w({count:O.COUNT})],Dt.prototype,"blitMode",void 0),m([w()],Dt.prototype,"hasOpacityFactor",void 0);let Mt=class extends Hi{constructor(){super(...arguments),this.opacity=1}};function Wi(r){const e=new tt;e.include(Ui),e.fragment.uniforms.add(new je("tex",i=>i.texture)),r.hasOpacityFactor&&e.fragment.uniforms.add(new S("opacity",i=>i.opacity));const t=r.blitMode===O.Depth;return t&&(e.fragment.uniforms.add(new ae("nearFar",(i,s)=>s.camera.nearFar)),e.fragment.include(qi),e.fragment.include(Xs)),e.fragment.main.add(g`
    ${t?g`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:g`
          fragColor = texture(tex, uv) ${r.hasOpacityFactor?"* opacity":""};`}`),e}const dn=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:Mt,build:Wi},Symbol.toStringTag,{value:"Module"}));let gt=class extends it{constructor(e,t,i){super(e,t,new rt(dn,()=>Ze(()=>Promise.resolve().then(()=>ma),void 0,import.meta.url)),i)}initializePipeline(e){switch(e.blitMode){case O.None:case O.Depth:return Ve({colorWrite:ze});case O.Alpha:return Ve({blending:As,colorWrite:ze});default:xi(e.blitMode);case O.PremultipliedAlpha:case O.COUNT:return Ve({blending:Ts,colorWrite:ze})}}},un=class{constructor(e,t=O.None){this._techniques=e,this._parameters=new Mt,this._configuration=new Dt,this._configuration.blitMode=t,e.precompile(gt,this._configuration)}blit(e,t,i,s){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(vt.COLOR),this._parameters.texture=t.getTexture();const n=this._techniques.acquire(gt,this._configuration);e.bindTechnique(n,s,this._parameters),e.screen.draw(),n.release()}blend(e,t,i,s,n=1){this._configuration.hasOpacityFactor=n<1;const a=this._techniques.acquire(gt,this._configuration);return a.compiled?(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=n,e.bindTechnique(a,s,this._parameters),e.screen.draw(),a.release(),!0):(a.release(),!1)}};function ki(r,e){const t=r.fragment;t.include(qi),r.include(as),t.uniforms.add(new S("globalAlpha",i=>i.globalAlpha),new j("glowColor",i=>i.glowColor),new S("glowWidth",(i,s)=>i.glowWidth*s.camera.pixelRatio),new S("glowFalloff",i=>i.glowFalloff),new j("innerColor",i=>i.innerColor),new S("innerWidth",(i,s)=>i.innerWidth*s.camera.pixelRatio),new je("depthMap",(i,s)=>{var n;return(n=s.depth)==null?void 0:n.attachment}),new je("normalMap",i=>i.normals)),t.code.add(g`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),t.code.add(g`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),t.code.add(g`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),t.code.add(g`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float angleCutoffAdjust, out float depthDiscontinuityAlpha) {
float depth = depthFromTexture(depthMap, uv);
if (depth == 1.0) {
return false;
}
float linearDepth = linearizeDepth(depth);
pos = reconstructPosition(gl_FragCoord.xy, linearDepth);
float minStep = 6e-8;
float depthStep = clamp(depth + minStep, 0.0, 1.0);
float linearDepthStep = linearizeDepth(depthStep);
float depthError = abs(linearDepthStep - linearDepth);
if (depthError > 0.2) {
normal = texture(normalMap, uv).xyz * 2.0 - 1.0;
angleCutoffAdjust = 0.004;
} else {
normal = normalize(cross(dFdx(pos), dFdy(pos)));
angleCutoffAdjust = 0.0;
}
float ddepth = fwidth(linearDepth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / linearDepth);
return true;
}`),e.contrastControlEnabled?(t.uniforms.add(new je("frameColor",(i,s)=>i.colors),new S("globalAlphaContrastBoost",i=>i.globalAlphaContrastBoost!=null?i.globalAlphaContrastBoost:1)),t.code.add(g`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`)):t.code.add(g`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}const jt=ye(6);function Bi(r){const e=new tt;e.include(Ui),e.include(ki,r);const t=e.fragment;if(r.lineVerticalPlaneEnabled||r.heightManifoldEnabled)if(t.uniforms.add(new S("maxPixelDistance",(i,s)=>r.heightManifoldEnabled?2*s.camera.computeScreenPixelSizeAt(i.heightManifoldTarget):2*s.camera.computeScreenPixelSizeAt(i.lineVerticalPlaneSegment.origin))),t.code.add(g`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),r.spherical){const i=(n,a,o)=>E(n,a.heightManifoldTarget,o.camera.viewMatrix),s=(n,a)=>E(n,[0,0,0],a.camera.viewMatrix);t.uniforms.add(new oe("heightManifoldOrigin",(n,a)=>(i(T,n,a),s(ne,a),x(ne,ne,T),C(R,ne),R[3]=Fe(ne),R)),new j("globalOrigin",(n,a)=>s(T,a)),new S("cosSphericalAngleThreshold",(n,a)=>1-Math.max(2,Ge(a.camera.eye,n.heightManifoldTarget)*a.camera.perRenderPixelRatio)/Fe(n.heightManifoldTarget))),t.code.add(g`float globeDistancePixels(float posInGlobalOriginLength) {
float dist = abs(posInGlobalOriginLength - heightManifoldOrigin.w);
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}
float heightManifoldDistancePixels(vec4 heightPlane, vec3 pos) {
vec3 posInGlobalOriginNorm = normalize(globalOrigin - pos);
float cosAngle = dot(posInGlobalOriginNorm, heightManifoldOrigin.xyz);
vec3 posInGlobalOrigin = globalOrigin - pos;
float posInGlobalOriginLength = length(posInGlobalOrigin);
float sphericalDistance = globeDistancePixels(posInGlobalOriginLength);
float planarDistance = planeDistancePixels(heightPlane, pos);
return cosAngle < cosSphericalAngleThreshold ? sphericalDistance : planarDistance;
}`)}else t.code.add(g`float heightManifoldDistancePixels(vec4 heightPlane, vec3 pos) {
return planeDistancePixels(heightPlane, pos);
}`);if(r.pointDistanceEnabled&&(t.uniforms.add(new S("maxPixelDistance",(i,s)=>2*s.camera.computeScreenPixelSizeAt(i.pointDistanceTarget))),t.code.add(g`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`)),r.intersectsLineEnabled&&(t.uniforms.add(new S("perScreenPixelRatio",(i,s)=>s.camera.perScreenPixelRatio)),t.code.add(g`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`)),(r.lineVerticalPlaneEnabled||r.intersectsLineEnabled)&&t.code.add(g`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),t.main.add(g`vec3 pos;
vec3 normal;
float angleCutoffAdjust;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, angleCutoffAdjust, depthDiscontinuityAlpha)) {
fragColor = vec4(0.0);
return;
}
vec4 color = vec4(0.0);`),r.heightManifoldEnabled){t.uniforms.add(new ae("angleCutoff",s=>$e(s)),new oe("heightPlane",(s,n)=>Yi(s.heightManifoldTarget,s.renderCoordsHelper.worldUpAtPosition(s.heightManifoldTarget,T),n.camera.viewMatrix)));const i=r.spherical?g`normalize(globalOrigin - pos)`:g`heightPlane.xyz`;t.main.add(g`
      vec2 angleCutoffAdjusted = angleCutoff - angleCutoffAdjust;
      // Fade out laserlines on flat surfaces
      float heightManifoldAlpha = 1.0 - smoothstep(angleCutoffAdjusted.x, angleCutoffAdjusted.y, abs(dot(normal, ${i})));
      vec4 heightManifoldColor = laserlineProfile(heightManifoldDistancePixels(heightPlane, pos));
      color = max(color, heightManifoldColor * heightManifoldAlpha);`)}return r.pointDistanceEnabled&&(t.uniforms.add(new ae("angleCutoff",i=>$e(i)),new oe("pointDistanceSphere",(i,s)=>pn(i,s))),t.main.add(g`float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);`)),r.lineVerticalPlaneEnabled&&(t.uniforms.add(new ae("angleCutoff",i=>$e(i)),new oe("lineVerticalPlane",(i,s)=>_n(i,s)),new j("lineVerticalStart",(i,s)=>gn(i,s)),new j("lineVerticalEnd",(i,s)=>fn(i,s))),t.main.add(g`if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}`)),r.intersectsLineEnabled&&(t.uniforms.add(new ae("angleCutoff",i=>$e(i)),new j("intersectsLineStart",(i,s)=>E(T,i.lineStartWorld,s.camera.viewMatrix)),new j("intersectsLineEnd",(i,s)=>E(T,i.lineEndWorld,s.camera.viewMatrix)),new j("intersectsLineDirection",(i,s)=>(b(R,i.intersectsLineSegment.vector),R[3]=0,C(T,$i(R,R,s.camera.viewMatrix)))),new S("intersectsLineRadius",i=>i.intersectsLineRadius)),t.main.add(g`if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}`)),t.main.add(g`fragColor = laserlineOutput(color * depthDiscontinuityAlpha);`),e}function $e(r){return Rt(mn,Math.cos(r.angleCutoff),Math.cos(Math.max(0,r.angleCutoff-ye(2))))}function pn(r,e){return E(rr(ft),r.pointDistanceOrigin,e.camera.viewMatrix),ft[3]=Ge(r.pointDistanceOrigin,r.pointDistanceTarget),ft}function _n(r,e){const t=B(r.lineVerticalPlaneSegment,.5,T),i=r.renderCoordsHelper.worldUpAtPosition(t,bn),s=C(ne,r.lineVerticalPlaneSegment.vector),n=we(T,i,s);return C(n,n),Yi(r.lineVerticalPlaneSegment.origin,n,e.camera.viewMatrix)}function gn(r,e){const t=b(T,r.lineVerticalPlaneSegment.origin);return r.renderCoordsHelper.setAltitude(t,0),E(t,t,e.camera.viewMatrix)}function fn(r,e){const t=V(T,r.lineVerticalPlaneSegment.origin,r.lineVerticalPlaneSegment.vector);return r.renderCoordsHelper.setAltitude(t,0),E(t,t,e.camera.viewMatrix)}function Yi(r,e,t){return E(ri,r,t),b(R,e),R[3]=0,$i(R,R,t),Ie(ri,R,vn)}const mn=Re(),T=h(),R=Ti(),bn=h(),ne=h(),ri=h(),vn=Et(),ft=sr(),yn=Object.freeze(Object.defineProperty({__proto__:null,build:Bi,defaultAngleCutoff:jt},Symbol.toStringTag,{value:"Module"}));let wn=class extends Hi{constructor(){super(...arguments),this.innerColor=Ne(1,1,1),this.innerWidth=1,this.glowColor=Ne(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=ye(6),this.pointDistanceOrigin=h(),this.pointDistanceTarget=h(),this.lineVerticalPlaneSegment=Se(),this.intersectsLineSegment=Se(),this.intersectsLineRadius=3,this.heightManifoldTarget=h(),this.lineStartWorld=h(),this.lineEndWorld=h()}},Pn=class extends it{constructor(e,t,i){super(e,t,new rt(yn,()=>Ze(()=>Promise.resolve().then(()=>ba),void 0,import.meta.url)),i)}};function Qi(r){const e=new tt;e.include(ki,r);const{vertex:t,fragment:i}=e;t.uniforms.add(new Zt("modelView",(n,{camera:a})=>nr(Dn,a.viewMatrix,n.origin)),new Zt("proj",(n,{camera:a})=>a.projectionMatrix),new S("glowWidth",(n,{camera:a})=>n.glowWidth*a.pixelRatio),new ae("pixelToNDC",(n,{camera:a})=>Rt(Sn,2/a.fullViewport[2],2/a.fullViewport[3]))),e.attributes.add(p.START,"vec3"),e.attributes.add(p.END,"vec3"),r.spherical&&(e.attributes.add(p.START_UP,"vec3"),e.attributes.add(p.END_UP,"vec3")),e.attributes.add(p.EXTRUDE,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vViewStart","vec3"),e.varyings.add("vViewEnd","vec3"),e.varyings.add("vViewSegmentNormal","vec3"),e.varyings.add("vViewStartNormal","vec3"),e.varyings.add("vViewEndNormal","vec3");const s=!r.spherical;return t.main.add(g`
    vec3 pos = mix(start, end, extrude.x);

    vec4 viewPos = modelView * vec4(pos, 1);
    vec4 projPos = proj * viewPos;
    vec2 ndcPos = projPos.xy / projPos.w;

    // in planar we hardcode the up vectors to be Z-up */
    ${ii(s,g`vec3 startUp = vec3(0, 0, 1);`)}
    ${ii(s,g`vec3 endUp = vec3(0, 0, 1);`)}

    // up vector corresponding to the location of the vertex, selecting either startUp or endUp */
    vec3 up = extrude.y * mix(startUp, endUp, extrude.x);
    vec3 viewUp = (modelView * vec4(up, 0)).xyz;

    vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
    vec2 projUp = normalize(projPosUp.xy / projPosUp.w - ndcPos);

    // extrude ndcPos along projUp to the edge of the screen
    vec2 lxy = abs(sign(projUp) - ndcPos);
    ndcPos += length(lxy) * projUp;

    vViewStart = (modelView * vec4(start, 1)).xyz;
    vViewEnd = (modelView * vec4(end, 1)).xyz;

    vec3 viewStartEndDir = vViewEnd - vViewStart;

    vec3 viewStartUp = (modelView * vec4(startUp, 0)).xyz;

    // the normal of the plane that aligns with the segment and the up vector
    vViewSegmentNormal = normalize(cross(viewStartUp, viewStartEndDir));

    // the normal orthogonal to the segment normal and the start up vector
    vViewStartNormal = -normalize(cross(vViewSegmentNormal, viewStartUp));

    // the normal orthogonal to the segment normal and the end up vector
    vec3 viewEndUp = (modelView * vec4(endUp, 0)).xyz;
    vViewEndNormal = normalize(cross(vViewSegmentNormal, viewEndUp));

    // Add enough padding in the X screen space direction for "glow"
    float xPaddingPixels = sign(dot(vViewSegmentNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
    ndcPos.x += xPaddingPixels * pixelToNDC.x;

    // uv is used to read back depth to reconstruct the position at the fragment
    uv = ndcPos * 0.5 + 0.5;

    gl_Position = vec4(ndcPos, 0, 1);
  `),i.uniforms.add(new S("perScreenPixelRatio",(n,a)=>a.camera.perScreenPixelRatio)),i.code.add(g`float planeDistance(vec3 planeNormal, vec3 planeOrigin, vec3 pos) {
return dot(planeNormal, pos - planeOrigin);
}
float segmentDistancePixels(vec3 segmentNormal, vec3 startNormal, vec3 endNormal, vec3 pos, vec3 start, vec3 end) {
float distSegmentPlane = planeDistance(segmentNormal, start, pos);
float distStartPlane = planeDistance(startNormal, start, pos);
float distEndPlane = planeDistance(endNormal, end, pos);
float dist = max(max(distStartPlane, distEndPlane), abs(distSegmentPlane));
float width = fwidth(distSegmentPlane);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}`),i.main.add(g`fragColor = vec4(0.0);
vec3 dEndStart = vViewEnd - vViewStart;
if (dot(dEndStart, dEndStart) < 1e-5) {
return;
}
vec3 pos;
vec3 normal;
float angleCutoffAdjust;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, angleCutoffAdjust, depthDiscontinuityAlpha)) {
return;
}
float distance = segmentDistancePixels(
vViewSegmentNormal,
vViewStartNormal,
vViewEndNormal,
pos,
vViewStart,
vViewEnd
);
vec4 color = laserlineProfile(distance);
float alpha = (1.0 - smoothstep(0.995 - angleCutoffAdjust, 0.999 - angleCutoffAdjust, abs(dot(normal, vViewSegmentNormal))));
fragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);`),e}const Sn=Re(),Dn=ee(),En=Object.freeze(Object.defineProperty({__proto__:null,build:Qi},Symbol.toStringTag,{value:"Module"}));let Rn=class extends wn{constructor(){super(...arguments),this.origin=h()}},mt=class extends it{constructor(e,t,i){super(e,t,new rt(En,()=>Ze(()=>Promise.resolve().then(()=>va),void 0,import.meta.url)),i,Xi)}};const Xi=new Map([[p.START,0],[p.END,1],[p.EXTRUDE,2],[p.START_UP,3],[p.END_UP,4]]);let si=class{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=h(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=ar(3*e.length);let i=0;for(const s of e)t[i++]=s[0],t[i++]=s[1],t[i++]=s[2];this.buffers=[t]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const t=this._buffers[0],i=3*Math.floor(t.length/3/2);Z(this._origin,t[i],t[i+1],t[i+2])}else Z(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const t=this._ensureVAO(e);t!=null&&(e.bindVAO(t),e.drawArrays(or.TRIANGLES,0,this._count))}dispose(){this._vao!=null&&this._vao.dispose()}get _layout(){return this._renderCoordsHelper.viewingMode===Ue.Global?xn:$n}_ensureVAO(e){return this._buffers==null?null:(this._vao??(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,t){const i=this._createDataBuffer(t);return this._dirty=!1,new es(e,Xi,new Map([["data",Ls(this._layout)]]),new Map([["data",Ms.createVertex(e,lr.STATIC_DRAW,i)]]))}_ensureVertexData(e,t){var s;if(!this._dirty)return;const i=this._createDataBuffer(t);(s=e.vertexBuffers.get("data"))==null||s.setData(i),this._dirty=!1}_createDataBuffer(e){const t=e.reduce((l,c)=>l+ni(c),0);this._count=t;const i=this._layout.createBuffer(t),s=this._origin;let n=0,a=0;const o="startUp"in i?this._setUpVectors.bind(this,i):void 0;for(const l of e){for(let c=0;c<l.length;c+=3){const d=Z(ai,l[c],l[c+1],l[c+2]);c===0?a=this._renderCoordsHelper.getAltitude(d):this._renderCoordsHelper.setAltitude(d,a);const u=n+2*c;o==null||o(c,u,l,d);const _=x(ai,d,s);if(c<l.length-3){for(let f=0;f<6;f++)i.start.setVec(u+f,_);i.extrude.setValues(u,0,-1),i.extrude.setValues(u+1,1,-1),i.extrude.setValues(u+2,1,1),i.extrude.setValues(u+3,0,-1),i.extrude.setValues(u+4,1,1),i.extrude.setValues(u+5,0,1)}if(c>0)for(let f=-6;f<0;f++)i.end.setVec(u+f,_)}n+=ni(l)}return i.buffer}_setUpVectors(e,t,i,s,n){const a=this._renderCoordsHelper.worldUpAtPosition(n,On);if(t<s.length-3)for(let o=0;o<6;o++)e.startUp.setVec(i+o,a);if(t>0)for(let o=-6;o<0;o++)e.endUp.setVec(i+o,a)}};function ni(r){return 3*(2*(r.length/3-1))}const On=h(),ai=h(),xn=$t().vec3f(p.START).vec3f(p.END).vec2f(p.EXTRUDE).vec3f(p.START_UP).vec3f(p.END_UP),$n=$t().vec3f(p.START).vec3f(p.END).vec2f(p.EXTRUDE);let Ee=class extends Ni{constructor(){super(...arguments),this.contrastControlEnabled=!1,this.spherical=!1}};m([w()],Ee.prototype,"contrastControlEnabled",void 0),m([w()],Ee.prototype,"spherical",void 0);let fe=class extends Ee{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1}};m([w()],fe.prototype,"heightManifoldEnabled",void 0),m([w()],fe.prototype,"pointDistanceEnabled",void 0),m([w()],fe.prototype,"lineVerticalPlaneEnabled",void 0),m([w()],fe.prototype,"intersectsLineEnabled",void 0);let Y=class extends os{constructor(e){super(e),this.produces=ut.LASERLINES,this.consumes={required:[ut.LASERLINES,"normals"]},this.requireGeometryDepth=!0,this._configuration=new fe,this._pathTechniqueConfiguration=new Ee,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._passParameters=new Rn;const t=e.view._stage.renderView.techniques,i=new Ee;i.contrastControlEnabled=e.contrastControlEnabled,t.precompile(mt,i)}initialize(){this._passParameters.renderCoordsHelper=this.view.renderCoordsHelper,this._pathTechniqueConfiguration.spherical=this.view.state.viewingMode===Ue.Global,this._pathTechniqueConfiguration.contrastControlEnabled=this.contrastControlEnabled,this._techniques.precompile(mt,this._pathTechniqueConfiguration),this._blit=new un(this._techniques,O.PremultipliedAlpha)}destroy(){this._pathVerticalPlaneData=cr(this._pathVerticalPlaneData),this._blit=null}get _techniques(){return this.view._stage.renderView.techniques}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this.requestRender(y.UPDATE))}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(e){b(this._passParameters.heightManifoldTarget,e),this.requestRender(y.UPDATE)}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this.requestRender(y.UPDATE))}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(e){b(this._passParameters.pointDistanceTarget,e),this.requestRender(y.UPDATE)}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(e){b(this._passParameters.pointDistanceOrigin,e),this.requestRender(y.UPDATE)}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this.requestRender(y.UPDATE))}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){ke(e,this._passParameters.lineVerticalPlaneSegment),this.requestRender(y.UPDATE)}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this.requestRender(y.UPDATE))}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(e){ke(e,this._passParameters.intersectsLineSegment),this.requestRender(y.UPDATE)}get intersectsLineRadius(){return this._passParameters.intersectsLineRadius}set intersectsLineRadius(e){e!==this._passParameters.intersectsLineRadius&&(this._passParameters.intersectsLineRadius=e,this.requestRender(y.UPDATE))}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this.requestRender(y.UPDATE))}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,this._pathVerticalPlaneData!=null&&this.requestRender(y.UPDATE))}set pathVerticalPlaneVertices(e){this._pathVerticalPlaneData==null&&(this._pathVerticalPlaneData=new si(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this.requestRender(y.UPDATE)}set pathVerticalPlaneBuffers(e){this._pathVerticalPlaneData==null&&(this._pathVerticalPlaneData=new si(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this.requestRender(y.UPDATE)}setParameters(e){ls(this._passParameters,e)&&this.requestRender(y.UPDATE)}precompile(){this._acquireTechnique().release()}render(e){const t=e.find(({name:o})=>o===ut.LASERLINES);if(!this.bindParameters.decorations||this._blit==null)return t;const i=this.renderingContext,s=e.find(({name:o})=>o==="normals");this._passParameters.normals=s==null?void 0:s.getTexture();const n=()=>{(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(),this.pathVerticalPlaneEnabled&&this._renderPath()};if(!this.contrastControlEnabled)return i.bindFramebuffer(t.fbo),n(),t;this._passParameters.colors=t.getTexture();const a=this.fboCache.acquire(t.fbo.width,t.fbo.height,"laser lines");return i.bindFramebuffer(a.fbo),i.setClearColor(0,0,0,0),i.clear(vt.COLOR|vt.DEPTH),n(),i.unbindTexture(t.getTexture()),this._blit.blend(i,a,t,this.bindParameters)||this.requestRender(y.UPDATE),a.release(),t}_acquireTechnique(){return this._configuration.heightManifoldEnabled=this.heightManifoldEnabled,this._configuration.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._configuration.pointDistanceEnabled=this.pointDistanceEnabled,this._configuration.intersectsLineEnabled=this.intersectsLineEnabled,this._configuration.contrastControlEnabled=this.contrastControlEnabled,this._configuration.spherical=this.view.state.viewingMode===Ue.Global,this._techniques.acquire(Pn,this._configuration)}_renderUnified(){if(!this._updatePassParameters())return;const e=this._acquireTechnique();if(e.compiled){const t=this.renderingContext;t.bindTechnique(e,this.bindParameters,this._passParameters),t.screen.draw()}else this.requestRender(y.UPDATE);e.release()}_renderPath(){if(this._pathVerticalPlaneData==null)return;const e=this._techniques.acquire(mt,this._pathTechniqueConfiguration);if(e.compiled){const t=this.renderingContext;this._passParameters.origin=this._pathVerticalPlaneData.origin,t.bindTechnique(e,this.bindParameters,this._passParameters),this._pathVerticalPlaneData.draw(t)}else this.requestRender(y.UPDATE);e.release()}_updatePassParameters(){if(!this._intersectsLineEnabled)return!0;const e=this.bindParameters.camera,t=this._passParameters;if(this._intersectsLineInfinite){if(zi(hr(t.intersectsLineSegment.origin,t.intersectsLineSegment.vector),_e),_e.c0=-Number.MAX_VALUE,!Fi(e.frustum,_e))return!1;Gi(_e,t.lineStartWorld),Ii(_e,t.lineEndWorld)}else b(t.lineStartWorld,t.intersectsLineSegment.origin),V(t.lineEndWorld,t.intersectsLineSegment.origin,t.intersectsLineSegment.vector);return!0}get test(){}};m([K({constructOnly:!0})],Y.prototype,"contrastControlEnabled",void 0),m([K({constructOnly:!0})],Y.prototype,"isDecoration",void 0),m([K()],Y.prototype,"produces",void 0),m([K()],Y.prototype,"consumes",void 0),Y=m([Oi("esri.views.3d.webgl-engine.effects.laserlines.LaserLineRenderer")],Y);const _e=Vi();class Tn extends Ct{constructor(e){super(e),this._angleCutoff=jt,this._style={},this._heightManifoldTarget=h(),this._heightManifoldEnabled=!1,this._intersectsLine=Se(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProperties(e)}get testData(){}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){e!=null?(b(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(e==null)return void(this.intersectsLine=null);const t=this.view.renderCoordsHelper.worldUpAtPosition(e,An);this.intersectsLine=Yr(e,t),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){e!=null?(ke(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=e!=null?ke(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=e!=null?{origin:Ft(e.origin),target:e.target?Ft(e.target):null}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||this._pointDistanceLine!=null||this._pathVerticalPlaneBuffers!=null)?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){this._renderer==null&&(this._renderer=new Y({view:this.view,contrastControlEnabled:!0,isDecoration:this.isDecoration}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff())}_syncStyle(){this._renderer!=null&&(this._renderer.setParameters(this._style),this._style.intersectsLineRadius!=null&&(this._renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){this._renderer!=null&&this._renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){this._renderer!=null&&(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){this._renderer!=null&&(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){this._renderer!=null&&(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){this._renderer!=null&&(this._renderer.pathVerticalPlaneEnabled=this._pathVerticalPlaneBuffers!=null&&this.visible,this._pathVerticalPlaneBuffers!=null&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){this._renderer!=null&&(this._renderer.lineVerticalPlaneEnabled=this._lineVerticalPlaneSegment!=null&&this.visible,this._lineVerticalPlaneSegment!=null&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){if(this._renderer==null)return;const e=this._pointDistanceLine,t=e!=null;this._renderer.pointDistanceEnabled=t&&e.target!=null&&this.visible,t&&(this._renderer.pointDistanceOrigin=e.origin,e.target!=null&&(this._renderer.pointDistanceTarget=e.target))}_disposeRenderer(){this._renderer!=null&&this.view._stage&&(this._renderer.destroy(),this._renderer=null)}}const An=h();let Cn=class extends Lt{constructor(e){super(e),this._ray=Je(),this._isWorldDown=!1,this._start=h(),this._end=Ne(1,0,0),this._width=1,this._color=z(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=z(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=$.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=P.OccludeAndTransparent,this._fadedExtensions=hi,this._laserline=new Tn({view:this.view,isDecoration:e.isDecoration}),this.applyProperties(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:oi,recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:oi,recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,b(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),x(this._end,e,this._end),ot(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,he(this._start,e)||(b(this._start,e),ot(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,he(this._end,e)||(b(this._end,e),ot(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){le(e,this._color)||(te(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){le(e,this._innerColor)||(te(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&le(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?dr(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===P.OccludeAndTransparentStencil?P.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??hi,this.recreateGeometry()}_updateMaterial(){var t,i;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(i=this.drapedResources.resources)==null||i.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new de(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:s=>{s(t),i.forEach(s)}}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const s=this._createGeometry(e);i.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new de(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);return this._updateVerticesDraped(t),new Tt(t)}_createGeometry(e){const t=this.extensionType===$.FADED,i=t?[h(),h(),h(),h()]:[h(),h()];return Xe(e,i,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===$.FADED?this._updateLineSegmentFinite(li):this._updateLineSegmentInfinite(this._extensionType,li)}_updateLineSegmentFinite(e){return Be(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(zi(this._ray,N),e){case $.LINE:N.c0=-Number.MAX_VALUE;break;case $.RAY:case $.GROUND_RAY:{const a=this._ray.origin,o=this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,l=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&l<o&&ur(N.ray.direction,N.ray.direction),this._extensionType===$.GROUND_RAY&&o!=null&&(N.c1=Math.abs(l-o));break}}if(!Fi(i.frustum,N))return this._updateLineSegmentFinite(t);const s=Gi(N,W),n=Ii(N,Ln);return Be(s,n,t)}_updateVertexAttributesObject3D(e,t){var n;const i=(n=e.geometries[0].getMutableAttribute(p.POSITION))==null?void 0:n.data;if(!i)return;let s=0;for(const a of this._lineVertices(t))i[s++]=a[0],i[s++]=a[1],i[s++]=a[2];e.geometryVertexAttributeUpdated(e.geometries[0],p.POSITION)}_updateVertexAttributesDraped(e,t){var n;const i=(n=e.getMutableAttribute(p.POSITION))==null?void 0:n.data;if(!i)return;let s=0;for(const a of this._lineVertices(t))i[s++]=a[0],i[s++]=a[1],i[s++]=Ye;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===$.FADED?(yield B(e,-this.fadedExtensions.start,W),yield B(e,0,W),yield B(e,1,W),yield B(e,1+this.fadedExtensions.end,W)):(yield B(e,0,W),yield B(e,1,W))}};function oi(r){r.geometries=[]}const N=Vi(),W=h(),Ln=h(),li=Se();var $;(function(r){r[r.LINE=0]="LINE",r[r.RAY=1]="RAY",r[r.GROUND_RAY=2]="GROUND_RAY",r[r.FADED=3]="FADED"})($||($={}));const ci=1/3,hi={start:ci,end:ci};let Mn=class extends Lt{constructor(e){super(e),this._location=h(),this._direction=Ne(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=z(1,0,1,1),this._renderOccluded=P.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:jn,recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Vn,recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){he(this._location,e)||(b(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){he(this._direction,e)||(b(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){C(this._direction,x(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){le(e,this._color)||(te(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new de(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:s=>{s(t),i.forEach(s)}}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const[s,n]=di(e);t.addGeometry(s),t.addGeometry(n),i.push(s),i.push(n),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new de(this.materialParameters),t=Ke(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=di(e);return this._updateVerticesDraped(t),t.map(i=>new Tt(i))}_updateMaterial(){var t,i;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(i=this.drapedResources.resources)==null||i.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Ae),V(L,this.location,this.direction),t.projectToScreen(L,se),pr(se,_r(se,se,Ae)),this._updateVertexAttributesObject3D(t,e,0,Ae,se,1),this._updateVertexAttributesObject3D(t,e,1,Ae,se,-1)}_updateVertexAttributesObject3D(e,t,i,s,n,a){var u;const o=t.geometries[i],l=(u=o.getMutableAttribute(p.POSITION))==null?void 0:u.data;if(!l)return;const{start:c,end:d}=ui(n,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(qe(c),L),l[0]=L[0],l[1]=L[1],l[2]=L[2],e.unprojectFromScreen(qe(d),L),l[3]=L[0],l[4]=L[1],l[5]=L[2],t.geometryVertexAttributeUpdated(o,p.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{location:s,width:n,length:a,offset:o}=this,l=zn;l.spatialReference=t.renderer.spatialReference,l.x=s[0],l.y=s[1];const c=this.view.overlayPixelSizeInMapUnits(l)*i,d=n*c,u=a*c,_=o*c;this._updateVertexAttributesDraped(e[0],d,u,_,-1),this._updateVertexAttributesDraped(e[1],d,u,_,1)}_updateVertexAttributesDraped(e,t,i,s,n){var u;const a=(u=e.getMutableAttribute(p.POSITION))==null?void 0:u.data;if(!a)return;const{location:o,direction:l}=this,{start:c,end:d}=ui(l,o,n,s,t,i);a[0]=c[0],a[1]=c[1],a[2]=Ye,a[3]=d[0],a[4]=d[1],a[5]=Ye,e.invalidateBoundingInfo()}};function di(r){return[Xe(r,[h(),h()]),Xe(r,[h(),h()])]}function ui(r,e,t,i,s,n){const a=lt(pi,Rt(pi,r[1]*t,r[0]*-t),i+s/2),o=Oe(Te,Oe(Te,Oe(Te,e,lt(Te,r,n/2)),a),a);return{start:o,end:Oe(_i,o,lt(_i,r,-n))}}function jn(r){r.geometries.length=0}function Vn(r){r.pixelRatioHandle.remove(),r.geometries=[]}const L=h(),pi=Re(),Te=Re(),_i=Re(),Ae=ie(),se=ie(),zn=Ai(0,0,void 0,null);class Fn extends Ct{constructor(e){super(e),this._resources=null,this._transform=ee()}get object(){return this._resources!=null?this._resources.object:null}get transform(){return this._transform}set transform(e){Ci(this._transform,e),this._resources!=null&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(this._resources==null)return;const e=this._resources.object,t=this.view._stage;t.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),e.visible=this.visible,t.addMany(e.geometries)}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const t=new Ot(e,{pickable:!1,updatePolicy:et.SYNC}),i=new xt({castShadow:!1});i.transformation=this._transform,this.createExternalResources(),this.createGeometries(i),e.addMany(i.geometries),this.forEachExternalMaterial(s=>e.add(s)),e.add(i),t.add(i),i.visible=this.visible,this._resources={layer:t,object:i}}destroyResources(){const e=this.view._stage;this._resources!=null&&e&&(e.remove(this._resources.object),this._resources.layer.destroy(),this.forEachExternalMaterial(t=>{e.remove(t)}),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){this._resources!=null&&(this._resources.object.visible=e)}}let gi=class extends Fn{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=z(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=z(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){le(e,this._color)||(te(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){le(e,this._outlineColor)||(te(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){var e;(e=this._material)==null||e.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(e==null)return;const t=e.geometries[0];if(t==null)return;const i=t.getMutableAttribute(p.SIZE).data,s=this._geometrySize;i[0]=s,i[1]=s,e.geometryVertexAttributeUpdated(e.geometries[0],p.SIZE)}get _materialParameters(){var e;return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:ts(this._primitive),distanceFieldBoundingBox:Gn,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:(e=this._texture)==null?void 0:e.id,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/me}createExternalResources(){this._texture=is(this._primitive,this._preferredTextureSize),this._material=new rs(this._materialParameters,this.view.state.viewingMode===Ue.Global);const e=this.view._stage;this._texture.load(e.renderView.renderingContext),e.add(this._texture)}destroyExternalResources(){this._texture&&(this.view._stage.remove(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();t!=null&&e.addGeometry(t)}forEachExternalMaterial(e){this._material&&e(this._material)}get _preferredTextureSize(){return gr(2*this._geometrySize,16,128)}calculateMapBounds(e){var s;const t=(s=this.object)==null?void 0:s.geometries[0];if(!t)return!1;const i=t.attributes.get(p.POSITION).data;return yt(i,this.view.renderCoordsHelper.spatialReference,fi,this.view.spatialReference),fr(e,fi),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(e==null||t==null)return null;const{renderCoordsHelper:i,elevationProvider:s}=this.view,n=Zr(e,s,Jr.fromElevationInfo(this.elevationInfo),i),a=Z(v.get(),e.x,e.y,n),o=v.get();yt(a,e.spatialReference,o,i.spatialReference);const l=this._geometrySize;return Ks(t,null,o,null,null,[l,l],[0,0,0,1])}};const me=ss,Gn=[me/2,me/2,1-me/2,1-me/2],fi=h();let In=class extends Lt{constructor(e){super(e),this._maxSize=0,this._position=h(),this._up=h(),this._right=h(),this._renderOccluded=P.OccludeAndTransparent,this._color=z(1,0,0,1),this._outlineColor=z(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=P.Opaque,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Nn}}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){te(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){te(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=this._outlineSize===0!=(e===0);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:t,next:i}){this._maxSize=Math.min(Ge(t,e),Ge(t,i))/3,C(this._up,x(this._up,e,t)),C(this._right,x(this._right,i,t)),b(this._position,t),this.recreateGeometry()}_createObject3DResources(e){const t=new Qe(this._quadMaterialParameters),i=this._outlineSize===0?void 0:new de(this._outlineMaterialParameters);return this._createObject3DGeometries(e,t,i),{quadMaterial:t,outlineMaterial:i,forEach:s=>{s(t),i&&s(i)}}}_createObject3DGeometries(e,t,i){if(he(this._up,wt)&&he(this._right,wt))return;const s=this._createGeometries(t,i);for(const n of s)e.addGeometry(n);this._updateTransformObject3D(e)}_createDrapedResources(){const e=new Qe(this._quadMaterialParameters),t=this._outlineSize===0?void 0:new de(this._outlineMaterialParameters),i=this._createGeometries(e,t).map(s=>new Tt(s));return this._setTransformDraped(i),{quadMaterial:e,outlineMaterial:t,geometries:i,pixelRatioHandle:Ke(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()})}}_createGeometries(e,t){const{up:i,right:s,corner:n}=this._getVertices(),a=Un(i,s,n,e);return t?[a,Xe(t,[i,n,s])]:[a]}_getVertices(){let e=this._up,t=this._right;const i=V(v.get(),e,t);return this.isDraped&&(e=b(v.get(),e),t=b(v.get(),t),e[2]=0,t[2]=0,i[2]=0),{up:e,right:t,corner:i}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(e=this.object3dResources.object){if(!e)return;const t=this.view.state.camera,i=this._size*t.computeScreenPixelSizeAt(this._position),s=Math.min(this._maxSize,i);Gt(U,this._position),It(U,U,[s,s,s]),e.transformation=U}_setTransformDraped(e){if(e.length===0)return;const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{_position:s,_size:n}=this,a=b(v.get(),s);a[2]=Ye;const o=qn;o.spatialReference=t.renderer.spatialReference,o.x=a[0],o.y=a[1];const l=n*(this.view.overlayPixelSizeInMapUnits(o)*i),c=Math.min(this._maxSize,l);Gt(U,a),It(U,U,[c,c,1]);for(const d of e)d.transformation=U}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){var e,t;(e=this.object3dResources.resources)==null||e.quadMaterial.setParameters(this._quadMaterialParameters),(t=this.drapedResources.resources)==null||t.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){var e,t,i,s;(t=(e=this.object3dResources.resources)==null?void 0:e.outlineMaterial)==null||t.setParameters(this._outlineMaterialParameters),(s=(i=this.drapedResources.resources)==null?void 0:i.outlineMaterial)==null||s.setParameters(this._outlineMaterialParameters)}};function Nn(r){r.pixelRatioHandle.remove(),r.geometries=[]}function Un(r,e,t,i){return new cs(i,[[p.POSITION,new en([0,0,0,...e,...r,...t],[0,1,2,1,2,3],3,!0)]])}const U=ee(),qn=Ai(0,0,void 0,null);class po extends tn{sortUniqueHints(e){return e.sort((t,i)=>(i instanceof Nt?i.length:0)-(t instanceof Nt?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:s}=t,n=ge(t);return pe(new gi({view:s,primitive:"circle",geometry:Ut(e.intersectionPoint,i),elevationInfo:e.isDraped?Li:Mi,size:20,outlineSize:2,color:n.intersectionPointColor,outlineColor:n.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:i,spatialReference:s}=t,n=ge(t),a=q(e.point,e.domain,t);return pe(new gi({view:i,primitive:"circle",geometry:Ut(a,s),elevationInfo:Ce(e),size:20,outlineSize:2,color:n.pointColor,outlineColor:n.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:i,spatialReference:s}=t,n=ge(t),a=q(e.lineStart,e.domain,t),o=q(e.lineEnd,e.domain,t);return pe(Hn(e.type,a,o,s,Ce(e),i,n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:s}=t,n=ge(t),{isDraped:a}=e,o=Ce(e),l=q(e.lineStart,e.domain,t),c=q(e.lineEnd,e.domain,t),d=X(l,s,o,i,a),u=X(c,s,o,i,a),_=mr(u,d,u,.5),f=new Mn({view:i,attached:!1,offset:A.parallelLineHintOffset,length:A.parallelLineHintLength,width:A.parallelLineHintWidth,color:n.parallelSignColor,location:_,renderOccluded:a?P.OccludeAndTransparent:P.Opaque,isDraped:a,renderGroup:De.SnappingHint,isDecoration:!0});return f.setDirectionFromPoints(d,_),f.attached=!0,pe(f)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:s}=t,n=ge(t),a=Ce(e),{isDraped:o}=e,l=q(e.previousVertex,e.domain,t),c=q(e.centerVertex,e.domain,t),d=q(e.nextVertex,e.domain,t),u=X(l,s,a,i,o),_=X(c,s,a,i,o),f=X(d,s,a,i,o);return pe(new In({view:i,attached:!0,color:o?n.rightAngleColorDraped:n.rightAngleColor,renderOccluded:o?P.OccludeAndTransparent:P.Transparent,outlineRenderOccluded:o?P.OccludeAndTransparent:P.Opaque,outlineColor:n.rightAngleOutlineColor,outlineSize:A.rightAngleHintOutlineSize,size:A.rightAngleHintSize,isDraped:o,geometry:{previous:u,center:_,next:f},renderGroup:De.SnappingHint,isDecoration:!0}))}}function ge(r){const{effectiveTheme:e}=r.view,t=qt.toUnitRGBA(e.accentColor),i=[0,0,0,0];return{intersectionPointColor:i,intersectionPointOutlineColor:t,pointColor:i,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:qt.toUnitRGBA(Br(e.accentColor,.5)),rightAngleOutlineColor:t}}function q(r,e,{selfSnappingZ:t,view:i,spatialReference:s}){return e&br.SELF&&vr(r)&&t!=null?yr(r,t,i,s):r}function Ce(r){return r.isDraped?Li:Mi}function Hn(r,e,t,i,s,n,a,o=!1,l=!0,c=!0){const d=X(e,i,s,n,o),u=X(t,i,s,n,o),_=new Cn({view:n,extensionType:$.FADED,start:d,end:u,isDraped:o,color:a.lineColor,renderOccluded:o?P.OccludeAndTransparent:P.Opaque,renderGroup:De.SnappingHint,isDecoration:!0});switch(r){case ct.TARGET:_.width=A.lineHintWidthTarget,_.fadedExtensions={start:0,end:A.lineHintFadedExtensions};break;case ct.REFERENCE_EXTENSION:_.width=A.lineHintWidthReference,_.fadedExtensions={start:0,end:0};break;case ct.REFERENCE:_.width=A.lineHintWidthReference,_.fadedExtensions={start:l?A.lineHintFadedExtensions:0,end:c?A.lineHintFadedExtensions:0}}return _.attached=!0,_}function X(r,e,t,i,s){const n=h();if(s){const a=i.basemapTerrain.overlayManager.renderer.spatialReference;yt(r,e,n,a)}else wr(r,e,t,i,n);return n}function _o(r,e,t=Je()){return ce(r,Pe(e),t),C(t.direction,t.direction),t}function ce(r,e,t){return Wn(r,r.screenToRender(e,Pt(v.get())),t)}function Wn(r,e,t){const i=Pt(Ht(v.get(),e));if(i[2]=0,!r.unprojectFromRenderScreen(i,t.origin))return null;const s=Pt(Ht(v.get(),e));s[2]=1;const n=r.unprojectFromRenderScreen(s,v.get());return n==null?null:(x(t.direction,n,t.origin),t)}function kn(r,e){return Ki(r,()=>e)}function go(r){return Ki(r,e=>e.plane)}function Ki(r,e){const t=h(),i=h();let s=!1;return n=>{const a=e(n);if(n.action==="start"){const c=Pe(n.screenStart,qe(Wt.get())),d=ce(r.state.camera,c,mi);d!=null&&(s=He(a,d,t))}if(!s)return null;const o=Pe(n.screenEnd,qe(Wt.get())),l=ce(r.state.camera,o,mi);return l==null?null:He(a,l,i)?{...n,renderStart:t,renderEnd:i,plane:a,ray:l}:null}}function Bn(r,e,t=0,i=null,s=null){let n=null;return a=>{if(a.action==="start"&&(n=r.sceneIntersectionHelper.intersectElevationFromScreen(ie(a.screenStart.x,a.screenStart.y),e,t,s),n!=null&&i!=null&&!St(n,n,i))||n==null)return null;const o=r.sceneIntersectionHelper.intersectElevationFromScreen(ie(a.screenEnd.x,a.screenEnd.y),e,t,s);return o!=null&&(i==null||St(o,o,i))?{...a,mapStart:n,mapEnd:o}:null}}function Yn(r,e,t,i=null,s=null){return Bn(r,t,Pr(e,r,t),i,s)}function fo(r,e,t,i){const s=t.toMap(r.screenStart);return s!=null?Yn(e,s,t.elevationInfo,i):null}function Qn(r,e){const t=Zn,i=Jn,s=Et();r.renderCoordsHelper.worldUpAtPosition(e,t);const n=we(Sr(s),t,x(i,e,r.state.camera.eye));return we(n,n,t),Ie(e,n,s)}function mo(r,e,t){let i=null;const s=new Dr;return s.next(kn(r,Qn(r,e))).next(Xn(r,e)).next(Kn(r,t)).next(n=>{n.mapEnd.x=n.mapStart.x,n.mapEnd.y=n.mapStart.y,i=n}),n=>(i=null,s.execute(n),i)}function Xn(r,e){const t=h(),i=Fe(e);r.renderCoordsHelper.worldUpAtPosition(e,t);const s=h(),n=h(),a=o=>(x(o,o,e),Er(t,o,o),r.viewingMode==="global"&&Fe(o)*Math.sign(Rr(t,o))<.001-i&&x(o,We(o,t,.001),e),V(o,o,e),o);return o=>(o.renderStart=a(b(s,o.renderStart)),o.renderEnd=a(b(n,o.renderEnd)),o)}function Kn(r,e){const t=r.renderCoordsHelper;return i=>{const s=t.fromRenderCoords(i.renderStart,new J({spatialReference:e})),n=t.fromRenderCoords(i.renderEnd,new J({spatialReference:e}));return s!=null&&n!=null?{...i,mapStart:s,mapEnd:n}:null}}var be;function bo(r){let e=null;return t=>{switch(t.action){case"start":e=r.disableDisplay();break;case"end":case"cancel":e!=null&&(e.remove(),e=null)}return t}}function vo(r,e=null){const t=Zs(r.state.viewingMode);t.options.selectionMode=!0,t.options.store=rn.MIN,t.options.hud=!1;const i=ie(),s={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},n=h(),a=e??r.spatialReference,o=c=>{r.map.ground&&r.map.ground.opacity<1?s.exclude.add(Jt):s.exclude.delete(Jt),r.sceneIntersectionHelper.intersectIntersectorScreen(Pe(c,i),t,s);const d=t.results.min;let u;if(d.getIntersectionPoint(n))u=d.intersector===sn.TERRAIN?be.GROUND:be.OTHER;else{if(!t.results.ground.getIntersectionPoint(n))return null;u=be.GROUND}return{location:r.renderCoordsHelper.fromRenderCoords(n,new J({spatialReference:a})),surfaceType:u}};let l;return c=>{if(c.action==="start"){const u=o(c.screenStart);l=u!=null?u.location:null}if(l==null)return null;const d=o(c.screenEnd);return(d==null?void 0:d.location)!=null?{...c,mapStart:l,mapEnd:d.location,surfaceType:d.surfaceType}:null}}(function(r){r[r.GROUND=0]="GROUND",r[r.OTHER=1]="OTHER"})(be||(be={}));const Zn=h(),Jn=h(),mi=Je();class yo{constructor(e){var i;this.metadata=void 0,this._camera=new ns,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=ee(),this._worldFrame=null,this._renderLocation=h(),this._renderLocationDirty=!0,this._location=new J({x:0,y:0,z:0}),this._elevationAlignedLocation=new J,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=xe.None,this._focused=!1,this.events=new Or.EventEmitter,this._screenLocation={screenPointArray:ie(),renderScreenPointArray:xr(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);const t=(i=this.view.state)==null?void 0:i.camera;t&&this._camera.copyFrom(t)}destroy(){this._applyObjectTransform=sa,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){var e;return(e=this.view)==null?void 0:e._stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),$r(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){bi(e)&&(this._screenLocationDirty=!0),Ci(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=ee()),ea(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){kt(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){kt(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const e=this._elevation.override!=null?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=Tr(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(bi(this._modelTransform)){const t=this._calculateModelTransformOffset(ra);e=V(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,t){if(!this.available)return null;const i=Pe(e,ta),s=this._getCollisionRadius(t),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Cr(this.screenLocation.screenPointArray,i)<s*s)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":{const a=this.collisionType.paths,o=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(o,Le),c=s*this.screenLocation.pixelSize,d=ce(this._camera,i,bt);if(d==null)return null;for(const u of a){if(u.length===0)continue;const _=E(ve,u[0],l);for(let f=1;f<u.length;f++){const D=E(wi,u[f],l),F=Xr(Be(_,D,vi),d);if(F!=null&&F<c*c){const G=V(v.get(),_,D);We(G,G,.5);const re=Qt(v.get());return this._camera.projectToRenderScreen(G,re),re[2]+n}b(_,D)}}break}case"disc":{const a=this.collisionType.direction,o=this.collisionType.offset??wt,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,Le),d=s*this.screenLocation.pixelSize,u=ce(this._camera,i,bt);if(u==null)return null;const _=Bt(yi,c),f=Yt(Si,a,_),D=E(Di,o,c);Ie(D,f,Me);const F=Pi;if(He(Me,u,F)&&Ar(F,D)<d*d)return this.screenLocation.renderScreenPointArray[2]+n;break}case"ribbon":{const{paths:a,direction:o}=this.collisionType,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,Le),d=s*this._camera.computeScreenPixelSizeAt(this.renderLocation),u=ce(this._camera,i,bt);if(u==null)return null;const _=Bt(yi,c),f=Yt(Si,o,_),D=this._calculateModelTransformPosition(Di);Ie(D,f,Me);const F=Pi;if(!He(Me,u,F))break;for(const G of a){if(G.length===0)continue;const re=E(ve,G[0],c);for(let st=1;st<G.length;st++){const nt=E(wi,G[st],c),Vt=Qr(Be(re,nt,vi),F);if(Vt!=null&&Vt<d*d){const at=V(v.get(),re,nt);We(at,at,.5);const zt=Qt(v.get());return this._camera.projectToRenderScreen(at,zt),zt[2]+n}b(re,nt)}}break}default:xi(this.collisionType)}return null}attach(e={manipulator3D:{}}){const t=this._stage;if(!t)return;const i=e.manipulator3D;i.engineLayerId==null?(this._engineLayer=new Ot(t,{pickable:!1,updatePolicy:et.SYNC}),i.engineLayerId=this._engineLayer.id):t!=null&&t.getObject&&(this._engineLayer=t.getObject(i.engineLayerId)),i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,this._materialIdReferences==null&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Lr(this._location.spatialReference,this.view.spatialReference)||(this.location=new J({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=t.engineLayerReferences===0;this._removeResourcesFromStage(),i&&(t.engineLayerId=null,Mr(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){St(this.location,Ei,e.spatialReference)&&jr(e.extent,Ei)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(this.elevationInfo==null)return;let e=null,t=0;const i=Vr(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":e=dt(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":t=(dt(this.view.elevationProvider,this.location,"ground")??0)+i;break;case"relative-to-scene":t=(dt(this.view.elevationProvider,this.location,"scene")??0)+i;break;case"absolute-height":t=i}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=Le;if(this.autoScaleRenderObjects===!0){const a=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(a,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),s=(this.focused?H.Focused:H.Unfocused)|(this.selected?H.Selected:H.Unselected),n=this._noDisplayCount>0;for(const{stateMask:a,objects:o}of i){if(n){for(const _ of o)_.visible=!1;continue}const l=(a&H.All)!==H.None,c=(a&xe.All)!==xe.None,d=!l||(s&a)==(a&H.All),u=!c||(this.state&a)==(a&xe.All);if(d&&u)for(const _ of o)_.visible=!0,_.transformation=t;else for(const _ of o)_.visible=!1}}_ensureEngineResources(){if(this._engineResources==null){const e=this._engineLayer,t=[],i=new Set;this.renderObjects.forEach(({geometry:{material:a}})=>{i.has(a)||(t.push(a),i.add(a))});const s=new Map;this._renderObjects.forEach(a=>{const o=new xt({castShadow:!1,geometries:[a.geometry]}),l=s.get(a.stateMask)||[];l.push(o),s.set(a.stateMask,l)});const n=[];s.forEach((a,o)=>n.push({stateMask:o,objects:a})),this._engineResources={objectsByState:n,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const e=this._stage;if(this._engineResourcesAddedToStage||this._engineResources==null||!e)return;const{objectsByState:t,layer:i,materials:s}=this._engineResources;s.forEach(n=>{const a=this._materialIdReferences,o=a.get(n.id)||0;o===0&&e.add(n),a.set(n.id,o+1)}),t.forEach(({objects:n})=>{i.addMany(n),e.addMany(n)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const e=this._stage;if(!this._engineResourcesAddedToStage||this._engineResources==null||!e)return;const{objectsByState:t,layer:i,materials:s}=this._engineResources;t.forEach(({objects:n})=>{i.removeMany(n),e.removeMany(n)}),s.forEach(n=>{const a=this._materialIdReferences,o=a.get(n.id);o===1?(e.remove(n),a.delete(n.id)):a.set(n.id,o-1)}),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,ia);return Z(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return x(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return zr(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Xt(t,t,this._worldFrame),Xt(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,this._applyObjectTransform!=null&&this._applyObjectTransform(t),t}get test(){}}function bi(r){return r[12]!==0||r[13]!==0||r[14]!==0}function ea(r,e,t){switch(r.viewingMode){case"local":return Ir(t),!0;case"global":{const i=Fr(r.renderCoordsHelper.spatialReference);return Gr(e,0,ve,0,i.radius),nn(ye(ve[0]),ye(ve[1]),t),!0}}}const ta=ie(),vi=Se(),bt=Je(),yi=Nr(),ia=ee(),Le=ee(),Me=Et(),ve=h(),wi=h(),Pi=h(),Si=h(),Di=h(),ra=h(),Ei=new J({x:0,y:0,z:0,spatialReference:null}),sa=()=>{};function na(r){var e;return(e=r==null?void 0:r.operations)==null?void 0:e.data.geometry}function aa(r,e){if(!e.screenSizeEnabled)return;const t=r.vertex;hs(t,e),t.uniforms.add(new S("perScreenPixelRatio",(i,s)=>s.camera.perScreenPixelRatio),new S("screenSizeScale",i=>i.screenSizeScale)).code.add(g`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function Zi(r){const e=new tt,t=r.terrainDepthTest&&r.output===At.Color;e.include(ds,r),e.include(aa,r),e.include(us,r),e.include(ps,r);const{vertex:i,fragment:s}=e;return s.include(_s),gs(i,r),s.uniforms.add(new oe("uColor",n=>n.color)),e.attributes.add(p.POSITION,"vec3"),e.varyings.add("vWorldPosition","vec3"),t&&e.varyings.add("depth","float"),r.screenSizeEnabled&&e.attributes.add(p.OFFSET,"vec3"),r.shadingEnabled&&(fs(i),e.attributes.add(p.NORMAL,"vec3"),e.varyings.add("vViewNormal","vec3"),s.uniforms.add(new j("shadingDirection",n=>n.shadingDirection)),s.uniforms.add(new oe("shadedColor",n=>oa(n.shadingTint,n.color)))),i.main.add(g`
      vWorldPosition = ${r.screenSizeEnabled?g`screenSizeScaling(offset, position)`:g`position`};
      ${r.shadingEnabled?g`vec3 worldNormal = normal;
                 vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`:""}
      ${t?g`depth = (view * vec4(vWorldPosition, 1.0)).z;`:""}
      gl_Position = transformPosition(proj, view, vWorldPosition);
  `),t&&e.include(ms,r),s.main.add(g`
      discardBySlice(vWorldPosition);
      ${t?g`terrainDepthTest(depth);`:""}
      ${r.shadingEnabled?g`vec3 viewNormalNorm = normalize(vViewNormal);
             float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
             vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`:g`vec4 finalColor = uColor;`}
      outputColorHighlightOID(finalColor, vWorldPosition);`),e}function oa(r,e){const t=1-r[3],i=r[3]+e[3]*t;return i===0?(k[3]=i,k):(k[0]=(r[0]*r[3]+e[0]*e[3]*t)/i,k[1]=(r[1]*r[3]+e[1]*e[3]*t)/i,k[2]=(r[2]*r[3]+e[2]*e[3]*t)/i,k[3]=e[3],k)}const k=Ti(),la=Object.freeze(Object.defineProperty({__proto__:null,build:Zi},Symbol.toStringTag,{value:"Module"}));let ca=class extends it{constructor(e,t,i){super(e,t,new rt(la,()=>Ze(()=>Promise.resolve().then(()=>ya),void 0,import.meta.url)),i,Ji)}initializePipeline(e){const{oitPass:t,output:i,transparent:s,cullFace:n,shadingEnabled:a}=e,o=t===ei.NONE,l=t===ei.FrontFace;return Ve({blending:i===At.Color&&s?bs(t):null,culling:Cs(n),depthTest:{func:l?ht.LESS:a?ht.LEQUAL:ht.LESS},depthWrite:vs(e),drawBuffers:ys(t,i),colorWrite:ze,polygonOffset:o||l?null:ws})}};const Ji=new Map([[p.POSITION,0],[p.NORMAL,1],[p.OFFSET,2]]);class M extends Ps{constructor(){super(...arguments),this.cullFace=ue.None,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=Ss.None,this.emissionSource=Ds.None,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}get discardInvisibleFragments(){return this.transparent}}m([w({count:ue.COUNT})],M.prototype,"cullFace",void 0),m([w()],M.prototype,"hasSlicePlane",void 0),m([w()],M.prototype,"transparent",void 0),m([w()],M.prototype,"writeDepth",void 0),m([w()],M.prototype,"screenSizeEnabled",void 0),m([w()],M.prototype,"shadingEnabled",void 0),m([w()],M.prototype,"terrainDepthTest",void 0),m([w()],M.prototype,"cullAboveTerrain",void 0);let ha=class extends Es{constructor(e){super(e,ua),this._configuration=new M,this.vertexAttributeLocations=Ji,this.supportsEdges=!0,this.produces=new Map([[pt.OPAQUE_MATERIAL,t=>t===At.Highlight||_t(t)&&!this.parameters.transparent],[pt.TRANSPARENT_MATERIAL,t=>_t(t)&&this.parameters.transparent&&this.parameters.writeDepth],[pt.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,t=>_t(t)&&this.parameters.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=on}intersect(e,t,i,s,n,a){if(this.parameters.screenSizeEnabled){const o=e.attributes.get(p.OFFSET);ti(e,i,s,n,{applyToVertex:(c,d,u,_)=>{const f=Z(Ri,o.data[3*_],o.data[3*_+1],o.data[3*_+2]),D=Z(_a,c,d,u);return We(f,f,this.parameters.screenSizeScale*i.camera.computeScreenPixelSizeAt(f)),V(D,D,f),[D[0],D[1],D[2]]},applyToAabb:c=>{const d=Ur(c,Ri);return qr(c,this.parameters.screenSizeScale*i.camera.computeScreenPixelSizeAt(d))}},a)}else ti(e,i,s,n,void 0,a)}createGLMaterial(e){return new da(e)}createBufferWriter(){return new pa(this.parameters.screenSizeEnabled)}};class da extends Rs{beginSlot(e){return this.acquireTechnique(ca,e)}}class ua extends Os{constructor(){super(...arguments),this.color=z(1,1,1,1),this.shadingTint=z(0,0,0,.25),this.shadingDirection=C(h(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=ue.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}get transparent(){return this.color[3]<1||this.forceTransparentMode}}let pa=class{constructor(e){this.screenSizeEnabled=e;const t=$t().vec3f(p.POSITION).vec3f(p.NORMAL);this.screenSizeEnabled&&t.vec3f(p.OFFSET),this.vertexBufferLayout=t}elementCount(e){return e.get(p.POSITION).indices.length}write(e,t,i,s,n,a){if(xs(i,s,this.vertexBufferLayout,e,t,n,a),this.screenSizeEnabled){if(!i.has(p.OFFSET))throw new Error(`${p.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const o=i.get(p.OFFSET);ln(o.size===3);const l=n.getField(p.OFFSET,an);if(!l)throw new Error("unable to acquire view for "+p.OFFSET);$s(o,t,l,a)}}}};const Ri=h(),_a=h();function Do(r,e=P.OccludeAndTransparent,t=!0){const i=ji(r),s=!(r[3]<1);return t?new ha({color:i,writeDepth:s,cullFace:ue.Back,renderOccluded:e,isDecoration:!0}):new Qe({color:i,writeDepth:s,cullFace:ue.Back,renderOccluded:e,isDecoration:!0})}function Eo(r,e=P.OccludeAndTransparent){const t=ji(r);return new Qe({color:t,writeDepth:!0,cullFace:ue.Front,renderOccluded:e,isDecoration:!0})}const Ro=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),Oo=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function xo(r,e,t,i){const s=x(v.get(),r,t),n=ga(s,we(v.get(),i,s),t,Wr.get());kr(n,n);const a=E(v.get(),e,n);return Math.atan2(a[1],a[0])}function ga(r,e,t,i){const s=C(v.get(),r),n=C(v.get(),e),a=we(v.get(),s,n);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=0,i[4]=n[0],i[5]=n[1],i[6]=n[2],i[7]=0,i[8]=a[0],i[9]=a[1],i[10]=a[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}function $o(r,e){const t=r.getViewForGraphic(e);return t!=null&&"computeAttachmentOrigin"in t?t.computeAttachmentOrigin(e,r.spatialReference):null}function To(r,e){const t=e.origin;t==null?fa(r,na(e)):r.elevationAlignedLocation=t}function fa(r,e){if(e==null)return;const t=e.type==="mesh"?e.origin:Js(e);t!=null&&(r.location=Hr(t))}class Ao{constructor(e,t=H.None){this.geometry=e,this.stateMask=t}}const ma=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:Mt,build:Wi},Symbol.toStringTag,{value:"Module"})),ba=Object.freeze(Object.defineProperty({__proto__:null,build:Bi,defaultAngleCutoff:jt},Symbol.toStringTag,{value:"Module"})),va=Object.freeze(Object.defineProperty({__proto__:null,build:Qi},Symbol.toStringTag,{value:"Module"})),Co=Object.freeze(Object.defineProperty({__proto__:null,build:js},Symbol.toStringTag,{value:"Module"})),Lo=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Vs,blurSize:zs,build:Fs,gridCellPixelSize:Gs,outlineSize:Is},Symbol.toStringTag,{value:"Module"})),Mo=Object.freeze(Object.defineProperty({__proto__:null,build:Ns},Symbol.toStringTag,{value:"Module"})),jo=Object.freeze(Object.defineProperty({__proto__:null,build:Us},Symbol.toStringTag,{value:"Module"})),Vo=Object.freeze(Object.defineProperty({__proto__:null,SingleHighlightBlurDrawParameters:qs,build:Hs},Symbol.toStringTag,{value:"Module"})),zo=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Ws,build:ks},Symbol.toStringTag,{value:"Module"})),Fo=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Bs,build:Ys},Symbol.toStringTag,{value:"Module"})),Go=Object.freeze(Object.defineProperty({__proto__:null,build:Qs},Symbol.toStringTag,{value:"Module"})),ya=Object.freeze(Object.defineProperty({__proto__:null,build:Zi},Symbol.toStringTag,{value:"Module"}));export{vo as B,kn as C,$o as D,Kn as F,Cn as G,Co as H,$ as M,fo as N,ga as O,go as P,po as R,gi as S,zo as T,yo as a,Fn as b,Tn as c,na as d,Ao as e,Do as f,Yn as g,mo as h,Eo as i,To as j,xo as k,Ro as l,_o as m,Oo as n,Lo as o,Mo as p,be as q,jo as r,Vo as s,Lt as t,Fo as u,Go as v,ha as w,bo as z};
