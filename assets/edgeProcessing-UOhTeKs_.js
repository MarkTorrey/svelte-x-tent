import{e as It}from"./deduplicate-QfgWUagS.js";import{H as x}from"./InterleavedLayout-anHqp-yr.js";import{e as f}from"./VertexAttribute-h46lBfqy.js";import{r as G}from"./glUtil-eBq9W4Bb.js";import{h0 as et,jo as pt,cU as At,cR as U,cC as nt,cF as z,cY as Ot,cX as ht,dc as lt,cD as ot,da as ft,cz as E,cH as dt,jh as St}from"./index-eSY5-lt-.js";const Tt=x().vec3f(f.POSITION).u16(f.COMPONENTINDEX),wt=x().vec2u8(f.SIDENESS);G(wt);const B=x().vec3f(f.POSITION0).vec3f(f.POSITION1).vec3f(f.NORMAL).u16(f.COMPONENTINDEX).u8(f.VARIANTOFFSET,{glNormalized:!0}).u8(f.VARIANTSTROKE).u8(f.VARIANTEXTENSION,{glNormalized:!0}),K=x().vec3f(f.POSITION0).vec3f(f.POSITION1).vec3f(f.NORMALA).vec3f(f.NORMALB).u16(f.COMPONENTINDEX).u8(f.VARIANTOFFSET,{glNormalized:!0}).u8(f.VARIANTSTROKE).u8(f.VARIANTEXTENSION,{glNormalized:!0});f.POSITION0,f.POSITION1,f.COMPONENTINDEX,f.VARIANTOFFSET,f.VARIANTSTROKE,f.VARIANTEXTENSION,f.NORMAL,f.NORMALA,f.NORMALB,f.SIDENESS;const P=-1;var rt;function Et(t,e,o,r=Rt){const s=t.vertices.position,i=t.vertices.componentIndex,m=et(r.anglePlanar),a=et(r.angleSignificantEdge),I=Math.cos(a),l=Math.cos(m),u=j.edge,A=u.position0,O=u.position1,p=u.faceNormal0,v=u.faceNormal1,h=Pt(t),$=Vt(t),n=$.length/4,c=e.allocate(n);let g=0;const N=n,d=o.allocate(N);let w=0,y=0,S=0;const J=pt(0,n),D=new Float32Array(n);D.forEach((R,T,F)=>{s.getVec($[4*T],A),s.getVec($[4*T+1],O),F[T]=At(A,O)}),J.sort((R,T)=>D[T]-D[R]);const Q=new Array,Z=new Array;for(let R=0;R<n;R++){const T=J[R],F=D[T],H=$[4*T],mt=$[4*T+1],M=$[4*T+2],_=$[4*T+3],tt=_===P;if(s.getVec(H,A),s.getVec(mt,O),tt)U(p,h[3*M],h[3*M+1],h[3*M+2]),nt(v,p),u.componentIndex=i.get(H),u.cosAngle=z(p,v);else{if(U(p,h[3*M],h[3*M+1],h[3*M+2]),U(v,h[3*_],h[3*_+1],h[3*_+2]),u.componentIndex=i.get(H),u.cosAngle=z(p,v),$t(u,l))continue;u.cosAngle<-.9999&&nt(v,p)}y+=F,S++,tt||vt(u,I)?(e.write(c,g++,u),Q.push(F)):yt(u,m)&&(o.write(d,w++,u),Z.push(F))}const gt=new Float32Array(Q.reverse()),Nt=new Float32Array(Z.reverse());return{regular:{instancesData:e.trim(c,g),lodInfo:{lengths:gt}},silhouette:{instancesData:o.trim(d,w),lodInfo:{lengths:Nt}},averageEdgeLength:y/S}}function vt(t,e){return t.cosAngle<e}function $t(t,e){return t.cosAngle>e}function yt(t,e){const o=Ot(t.cosAngle),r=j.fwd,s=j.ortho;return ht(r,t.position1,t.position0),o*(z(lt(s,t.faceNormal0,t.faceNormal1),r)>0?-1:1)>e}function Vt(t){const e=t.faces.length/3,o=t.faces,r=t.neighbors;let s=0;for(let a=0;a<e;a++){const I=r[3*a],l=r[3*a+1],u=r[3*a+2],A=o[3*a],O=o[3*a+1],p=o[3*a+2];s+=I===P||A<O?1:0,s+=l===P||O<p?1:0,s+=u===P||p<A?1:0}const i=new Int32Array(4*s);let m=0;for(let a=0;a<e;a++){const I=r[3*a],l=r[3*a+1],u=r[3*a+2],A=o[3*a],O=o[3*a+1],p=o[3*a+2];(I===P||A<O)&&(i[m++]=A,i[m++]=O,i[m++]=a,i[m++]=I),(l===P||O<p)&&(i[m++]=O,i[m++]=p,i[m++]=a,i[m++]=l),(u===P||p<A)&&(i[m++]=p,i[m++]=A,i[m++]=a,i[m++]=u)}return i}function Pt(t){const e=t.faces.length/3,o=t.vertices.position,r=t.faces,s=W.v0,i=W.v1,m=W.v2,a=new Float32Array(3*e);for(let I=0;I<e;I++){const l=r[3*I],u=r[3*I+1],A=r[3*I+2];o.getVec(l,s),o.getVec(u,i),o.getVec(A,m),ot(i,i,s),ot(m,m,s),lt(s,i,m),ft(s,s),a[3*I]=s[0],a[3*I+1]=s[1],a[3*I+2]=s[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(rt||(rt={}));const j={edge:{position0:E(),position1:E(),faceNormal0:E(),faceNormal1:E(),componentIndex:0,cosAngle:0},ortho:E(),fwd:E()},W={v0:E(),v1:E(),v2:E()},Rt={anglePlanar:4,angleSignificantEdge:35};function st(t,e,o){const r=e/3,s=new Uint32Array(o+1),i=new Uint32Array(o+1),m=(n,c)=>{n<c?s[n+1]++:i[c+1]++};for(let n=0;n<r;n++){const c=t[3*n],g=t[3*n+1],N=t[3*n+2];m(c,g),m(g,N),m(N,c)}let a=0,I=0;for(let n=0;n<o;n++){const c=s[n+1],g=i[n+1];s[n+1]=a,i[n+1]=I,a+=c,I+=g}const l=new Uint32Array(6*r),u=s[o],A=(n,c,g)=>{if(n<c){const N=s[n+1]++;l[2*N]=c,l[2*N+1]=g}else{const N=i[c+1]++;l[2*u+2*N]=n,l[2*u+2*N+1]=g}};for(let n=0;n<r;n++){const c=t[3*n],g=t[3*n+1],N=t[3*n+2];A(c,g,n),A(g,N,n),A(N,c,n)}const O=(n,c)=>{const g=2*n,N=c-n;for(let d=1;d<N;d++){const w=l[g+2*d],y=l[g+2*d+1];let S=d-1;for(;S>=0&&l[g+2*S]>w;S--)l[g+2*S+2]=l[g+2*S],l[g+2*S+3]=l[g+2*S+1];l[g+2*S+2]=w,l[g+2*S+3]=y}};for(let n=0;n<o;n++)O(s[n],s[n+1]),O(u+i[n],u+i[n+1]);const p=new Int32Array(3*r),v=(n,c)=>n===t[3*c]?0:n===t[3*c+1]?1:n===t[3*c+2]?2:-1,h=(n,c)=>{const g=v(n,c);p[3*c+g]=-1},$=(n,c,g,N)=>{const d=v(n,c);p[3*c+d]=N;const w=v(g,N);p[3*N+w]=c};for(let n=0;n<o;n++){let c=s[n];const g=s[n+1];let N=i[n];const d=i[n+1];for(;c<g&&N<d;){const w=l[2*c],y=l[2*u+2*N];w===y?($(n,l[2*c+1],y,l[2*u+2*N+1]),c++,N++):w<y?(h(n,l[2*c+1]),c++):(h(y,l[2*u+2*N+1]),N++)}for(;c<g;)h(n,l[2*c+1]),c++;for(;N<d;)h(l[2*u+2*N],l[2*u+2*N+1]),N++}return p}let ut=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Lt:Mt}write(e,o,r){const s=this._edgeHashFunction(r);X.seed=s;const i=X.getIntRange(0,255),m=X.getIntRange(0,this.settings.variants-1),a=.7,I=X.getFloat(),l=255*(.5*xt(-(1-Math.min(I/a,1))+Math.max(0,I-a)/(1-a),1.2)+.5);e.position0.setVec(o,r.position0),e.position1.setVec(o,r.position1),e.componentIndex.set(o,r.componentIndex),e.variantOffset.set(o,i),e.variantStroke.set(o,m),e.variantExtension.set(o,l)}trim(e,o){return e.slice(0,o)}};const Y=new Float32Array(6),b=new Uint32Array(Y.buffer),V=new Uint32Array(1);function Mt(t){const e=Y;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],V[0]=5381;for(let o=0;o<b.length;o++)V[0]=31*V[0]+b[o];return V[0]}function Lt(t){const e=Y;e[0]=L(t.position0[0]),e[1]=L(t.position0[1]),e[2]=L(t.position0[2]),e[3]=L(t.position1[0]),e[4]=L(t.position1[1]),e[5]=L(t.position1[2]),V[0]=5381;for(let o=0;o<b.length;o++)V[0]=31*V[0]+b[o];return V[0]}const ct=1e4;function L(t){return Math.round(t*ct)/ct}function xt(t,e){const o=t<0?-1:1;return Math.abs(t)**e*o}let k=class{constructor(){this._commonWriter=new ut}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return B.createBuffer(e)}write(e,o,r){this._commonWriter.write(e,o,r),dt(C,r.faceNormal0,r.faceNormal1),ft(C,C),e.normal.setVec(o,C)}trim(e,o){return this._commonWriter.trim(e,o)}};k.Layout=B,k.glLayout=G(B,1);class q{constructor(){this._commonWriter=new ut}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return K.createBuffer(e)}write(e,o,r){this._commonWriter.write(e,o,r),e.normalA.setVec(o,r.faceNormal0),e.normalB.setVec(o,r.faceNormal1)}trim(e,o){return this._commonWriter.trim(e,o)}}q.Layout=K,q.glLayout=G(K,1);const C=E(),X=new St;function zt(t){const e=Ft(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return it.updateSettings(t.writerSettings),at.updateSettings(t.writerSettings),Et(e,it,at)}function Ft(t,e,o,r){if(e){const m=st(o,r,t.count);return new Dt(o,r,m,t)}const s=It(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:r}),i=st(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:i,vertices:Tt.createView(s.buffer)}}class Dt{constructor(e,o,r,s){this.faces=e,this.facesLength=o,this.neighbors=r,this.vertices=s}}const it=new k,at=new q,Bt=x().vec3f(f.POSITION0).vec3f(f.POSITION1),Kt=x().vec3f(f.POSITION0).vec3f(f.POSITION1).u16(f.COMPONENTINDEX);export{Tt as T,Bt as d,zt as f,Kt as m,Et as p,Ft as u};
